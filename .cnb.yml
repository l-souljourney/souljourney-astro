# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢é¡¹ç›® - ä½¿ç”¨Dockerç¼“å­˜æ–¹æ¡ˆ

# é€šç”¨é…ç½®é”šç‚¹
.common_config: &common_config
  imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml

# é€šç”¨æ„å»ºæ­¥éª¤ï¼ˆä½¿ç”¨ç¼“å­˜é•œåƒï¼‰
.build_with_cache: &build_with_cache
  - /usr/local/bin/setup-cache.sh

# æ„å»ºAstroé¡¹ç›®æ­¥éª¤
.astro_build: &astro_build
  - echo "ğŸ—ï¸ === å¼€å§‹æ„å»ºAstroé¡¹ç›® ==="
  - export PATH="/usr/local/bin:$PATH"
  - which pnpm
  - time pnpm run build
  - echo "ğŸ“Š === æ„å»ºäº§ç‰©ç»Ÿè®¡ ==="
  - ls -la dist/
  - du -sh dist/
  - find dist/ -type f | wc -l | xargs echo "æ–‡ä»¶æ€»æ•°ï¼š"

# ===== åˆ†æ”¯é…ç½® =====

# ä¸»åˆ†æ”¯ï¼šç”Ÿäº§ç¯å¢ƒæ„å»º+éƒ¨ç½²
main:
  push:
    - <<: *common_config
      docker:
        image: node:18-alpine
      stages:
        # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºä¾èµ–ç¼“å­˜é•œåƒ
        - name: build-cache
          type: docker:cache
          options:
            dockerfile: cache.dockerfile
            by:
              - package.json
              - pnpm-lock.yaml
            versionBy:
              - pnpm-lock.yaml
            sync: false
          exports:
            name: CACHE_IMAGE
        # ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ„å»ºé¡¹ç›®
        - name: build-with-cache
          image: $CACHE_IMAGE
          commands: *build_with_cache
        - name: build-astro
          commands: *astro_build
        # ç¬¬ä¸‰é˜¶æ®µï¼šéƒ¨ç½²åˆ°COS
        - name: deploy-cos
          commands:
            - echo "â˜ï¸ === å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘COS ==="
            - echo "é…ç½®ä¿¡æ¯ï¼š"
            - echo "- å­˜å‚¨æ¡¶ï¼š$COS_BUCKET"
            - echo "- åŒºåŸŸï¼š$COS_REGION"
            - echo "- è·¯å¾„ï¼š/"
          plugins:
            - name: cnbcool/tencent-cos
              with:
                secret_id: ${COS_SECRET_ID}
                secret_key: ${COS_SECRET_KEY}
                bucket: ${COS_BUCKET}
                region: ${COS_REGION}
                src: dist/
                dest: /
                delete: true
        # ç¬¬å››é˜¶æ®µï¼šCDNåˆ·æ–°ï¼ˆå¦‚æœé…ç½®äº†CDNåŸŸåï¼‰
        - name: refresh-cdn
          if: ${CDN_DOMAIN}
          plugins:
            - name: cnbcool/tencent-cdn
              with:
                domain: ${CDN_DOMAIN}
                secret_id: ${COS_SECRET_ID}
                secret_key: ${COS_SECRET_KEY}
                type: directory
                path: /
        # ç¬¬äº”é˜¶æ®µï¼šåŒæ­¥åˆ°GitHubï¼ˆå¦‚æœé…ç½®äº†GitHub Tokenï¼‰
        - name: sync-github
          if: ${GITHUB_TOKEN}
          commands:
            - echo "ğŸ”„ === åŒæ­¥åˆ°GitHub ==="
            - apk add --no-cache git
            - git config --global user.name "CNB Deploy Bot"
            - git config --global user.email "noreply@cnb.cool"
            - git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git || git remote set-url github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git
            - git push github main --force
            - echo "âœ… GitHubåŒæ­¥å®Œæˆ"

# å¼€å‘åˆ†æ”¯ï¼šä»…æ„å»ºæµ‹è¯•
develop:
  push:
    - <<: *common_config
      docker:
        image: node:18-alpine
      stages:
        # æ„å»ºä¾èµ–ç¼“å­˜é•œåƒ
        - name: build-cache
          type: docker:cache
          options:
            dockerfile: cache.dockerfile
            by:
              - package.json
              - pnpm-lock.yaml
            versionBy:
              - pnpm-lock.yaml
            sync: false
          exports:
            name: CACHE_IMAGE
        # ä½¿ç”¨ç¼“å­˜æ„å»ºé¡¹ç›®
        - name: build-with-cache
          image: $CACHE_IMAGE
          commands: *build_with_cache
        - name: build-astro
          commands: *astro_build
        - name: test-complete
          script: echo "âœ… å¼€å‘ç¯å¢ƒæ„å»ºæµ‹è¯•å®Œæˆ"

# PRåˆ†æ”¯ï¼šå¿«é€Ÿæ„å»ºæ£€æŸ¥
"**":
  pull_request:
    - <<: *common_config
      docker:
        image: node:18-alpine
      stages:
        # æ„å»ºä¾èµ–ç¼“å­˜é•œåƒ
        - name: build-cache
          type: docker:cache
          options:
            dockerfile: cache.dockerfile
            by:
              - package.json
              - pnpm-lock.yaml
            versionBy:
              - pnpm-lock.yaml
            sync: false
          exports:
            name: CACHE_IMAGE
        # ä½¿ç”¨ç¼“å­˜å¿«é€Ÿæ„å»º
        - name: build-with-cache
          image: $CACHE_IMAGE
          commands: *build_with_cache
        - name: build-astro
          commands: *astro_build
        - name: pr-check-complete
          script: echo "âœ… PRæ„å»ºæ£€æŸ¥å®Œæˆ"


