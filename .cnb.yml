# 腾讯云 CNB 构建配置文件
# L-Souljourney 博客项目

main:
  push:
    name: 主分支部署流水线
    env:
      TZ: Asia/Shanghai
      NODE_ENV: production
    image: node:18-alpine
    script: |
      echo "🔧 === 环境准备 ==="
      node --version
      npm --version
      echo "安装pnpm..."
      npm install -g pnpm
      pnpm --version
      echo "环境准备完成 ✅"
      
      echo "📦 === 安装项目依赖 ==="
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      echo "依赖安装完成 ✅"
      
      echo "🏗️ === 构建Astro项目 ==="
      pnpm build
      echo "=== 构建产物检查 ==="
      ls -la dist/
      echo "文件总数: $(find dist -type f | wc -l)"
      echo "构建完成 ✅"
      
      echo "🚀 === 部署到腾讯云COS ==="
      echo "使用COS插件部署..."
    plugins:
      - name: cnbcool/tencent-cos
        with:
          secret_id: ${COS_SECRET_ID}
          secret_key: ${COS_SECRET_KEY}
          bucket: ${COS_BUCKET}
          region: ${COS_REGION}
          src: dist/
          dest: /
          delete: true
          exclude: |
            *.tmp
            .DS_Store
      - name: cnbcool/tencent-cdn
        if: env.CDN_DOMAIN
        with:
          secret_id: ${COS_SECRET_ID}
          secret_key: ${COS_SECRET_KEY}
          domain: ${CDN_DOMAIN}
          type: purge
          urls: |
            https://${CDN_DOMAIN}/
            https://${CDN_DOMAIN}/index.html
      - name: github-sync
        if: env.GITHUB_TOKEN
        script: |
          echo "📤 === 同步到GitHub ==="
          git config --global user.name "CNB Deploy Bot"
          git config --global user.email "noreply@cnb.cool"
          git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git || true
          git push github main --force
          echo "GitHub同步完成 ✅"

develop:
  push:
    name: 开发分支测试流水线
    env:
      TZ: Asia/Shanghai
      NODE_ENV: development
    image: node:18-alpine
    script: |
      echo "🧪 === 开发环境构建测试 ==="
      node --version
      npm --version
      npm install -g pnpm
      pnpm --version
      
      echo "📦 === 安装依赖 ==="
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      
      echo "🏗️ === 构建测试 ==="
      pnpm build
      ls -la dist/
      echo "开发环境构建测试完成 ✅"

"**":
  pull_request:
    name: PR构建检查
    env:
      TZ: Asia/Shanghai
    image: node:18-alpine
    script: |
      echo "🔍 === PR构建检查 ==="
      node --version
      npm install -g pnpm
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      pnpm build
      echo "PR检查完成 ✅"

"$":
  push:
    name: 默认分支构建
    env:
      TZ: Asia/Shanghai
    image: node:18-alpine
    script: |
      echo "🔧 === 基础构建测试 ==="
      node --version
      npm install -g pnpm
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      pnpm build
      echo "基础构建完成 ✅"
