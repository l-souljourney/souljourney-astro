# CNB æ„å»ºé…ç½®æ–‡ä»¶ - ä½¿ç”¨å®˜æ–¹COSæ’ä»¶
# é‡‡ç”¨CNBå®˜æ–¹è…¾è®¯äº‘COSCMDæ’ä»¶

# ç¯å¢ƒå˜é‡å¯¼å…¥ - å°è¯•ä½¿ç”¨ä»“åº“å¼•ç”¨æ ¼å¼
env:
  imports:
    - l-souljourney/env@main:env.yml

# ä¸»åˆ†æ”¯ï¼šç”Ÿäº§ç¯å¢ƒæ„å»º+éƒ¨ç½²
main:
  push:
    - docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: setup environment
          script: |
            echo "ğŸš€ å¼€å§‹ç¯å¢ƒå‡†å¤‡..."
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
            
        - name: install dependencies
          script: |
            echo "ğŸ“¦ å¼€å§‹å®‰è£…ä¾èµ–..."
            time pnpm install --frozen-lockfile
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            
        - name: build project
          script: |
            echo "ğŸ—ï¸ å¼€å§‹æ„å»ºé¡¹ç›®..."
            time pnpm run build
            echo "ğŸ“Š æ„å»ºäº§ç‰©å¤§å°:"
            du -sh dist/
            ls -la dist/
            echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
            
        - name: debug environment variables
          script: |
            echo "ğŸ” å¼€å§‹ç¯å¢ƒå˜é‡è°ƒè¯•..."
            echo "=== ç³»ç»Ÿç¯å¢ƒå˜é‡è°ƒè¯• ==="
            echo "å½“å‰ç”¨æˆ·: $(whoami)"
            echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
            echo "Shellç±»å‹: $SHELL"
            
            echo "=== CNBå†…ç½®ç¯å¢ƒå˜é‡æ£€æŸ¥ ==="
            echo "CNB: ${CNB:-æœªè®¾ç½®}"
            echo "CI: ${CI:-æœªè®¾ç½®}"
            echo "CNB_BUILD_ID: ${CNB_BUILD_ID:-æœªè®¾ç½®}"
            echo "CNB_REPO_SLUG: ${CNB_REPO_SLUG:-æœªè®¾ç½®}"
            
            echo "=== ç›®æ ‡COSç¯å¢ƒå˜é‡è¯¦ç»†æ£€æŸ¥ ==="
            echo "æ£€æŸ¥COS_SECRET_ID:"
            if [ -n "${COS_SECRET_ID}" ]; then
              echo "  âœ… COS_SECRET_ID å·²è®¾ç½®ï¼Œé•¿åº¦: ${#COS_SECRET_ID}"
              echo "  å€¼: ${COS_SECRET_ID:0:10}..."
            else
              echo "  âŒ COS_SECRET_ID æœªè®¾ç½®æˆ–ä¸ºç©º"
            fi
            
            echo "æ£€æŸ¥COS_SECRET_KEY:"
            if [ -n "${COS_SECRET_KEY}" ]; then
              echo "  âœ… COS_SECRET_KEY å·²è®¾ç½®ï¼Œé•¿åº¦: ${#COS_SECRET_KEY}"
              echo "  å€¼: ${COS_SECRET_KEY:0:5}..."
            else
              echo "  âŒ COS_SECRET_KEY æœªè®¾ç½®æˆ–ä¸ºç©º"
            fi
            
            echo "æ£€æŸ¥COS_BUCKET:"
            if [ -n "${COS_BUCKET}" ]; then
              echo "  âœ… COS_BUCKET å·²è®¾ç½®: ${COS_BUCKET}"
            else
              echo "  âŒ COS_BUCKET æœªè®¾ç½®æˆ–ä¸ºç©º"
              echo "  åŸå§‹å€¼æ£€æŸ¥: '${COS_BUCKET}'"
              echo "  å˜é‡ç±»å‹: $(declare -p COS_BUCKET 2>/dev/null || echo 'å˜é‡æœªå£°æ˜')"
            fi
            
            echo "æ£€æŸ¥COS_REGION:"
            if [ -n "${COS_REGION}" ]; then
              echo "  âœ… COS_REGION å·²è®¾ç½®: ${COS_REGION}"
            else
              echo "  âŒ COS_REGION æœªè®¾ç½®æˆ–ä¸ºç©º"
              echo "  åŸå§‹å€¼æ£€æŸ¥: '${COS_REGION}'"
              echo "  å˜é‡ç±»å‹: $(declare -p COS_REGION 2>/dev/null || echo 'å˜é‡æœªå£°æ˜')"
            fi
            
            echo "=== æ‰€æœ‰ç¯å¢ƒå˜é‡æ‰«æ ==="
            echo "åŒ…å«COSçš„ç¯å¢ƒå˜é‡:"
            env | grep -i cos || echo "æœªæ‰¾åˆ°åŒ…å«COSçš„ç¯å¢ƒå˜é‡"
            
            echo "åŒ…å«SECRETçš„ç¯å¢ƒå˜é‡:"
            env | grep -i secret | sed 's/=.*/=***/' || echo "æœªæ‰¾åˆ°åŒ…å«SECRETçš„ç¯å¢ƒå˜é‡"
            
            echo "=== ç¯å¢ƒå˜é‡æ–‡ä»¶æ£€æŸ¥ ==="
            echo "æ£€æŸ¥å¯èƒ½çš„é…ç½®æ–‡ä»¶:"
            ls -la /etc/environment 2>/dev/null || echo "/etc/environment ä¸å­˜åœ¨"
            ls -la ~/.bashrc 2>/dev/null || echo "~/.bashrc ä¸å­˜åœ¨"
            ls -la ~/.profile 2>/dev/null || echo "~/.profile ä¸å­˜åœ¨"
            
            echo "ğŸ” ç¯å¢ƒå˜é‡è°ƒè¯•å®Œæˆ"
            
        - name: deploy to cos
          # ä½¿ç”¨å®˜æ–¹è…¾è®¯äº‘coscliæ’ä»¶ - å‚è€ƒdemoæ­£ç¡®è¯­æ³•
          image: tencentcom/coscli
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘COS..."
            
            # è¯¦ç»†éªŒè¯ç¯å¢ƒå˜é‡
            echo "=== COSéƒ¨ç½²é˜¶æ®µç¯å¢ƒå˜é‡æ£€æŸ¥ ==="
            echo "å½“å‰å®¹å™¨: $(hostname)"
            echo "å®¹å™¨é•œåƒ: tencentcom/coscli"
            
            # é€ä¸€æ£€æŸ¥ç¯å¢ƒå˜é‡
            echo "æ£€æŸ¥COS_SECRET_ID:"
            if [ -n "${COS_SECRET_ID}" ]; then
              echo "  âœ… COS_SECRET_ID: ${COS_SECRET_ID:0:10}*** (é•¿åº¦: ${#COS_SECRET_ID})"
            else
              echo "  âŒ COS_SECRET_ID: æœªè®¾ç½®æˆ–ä¸ºç©º"
              echo "  è¯¦ç»†ä¿¡æ¯: '${COS_SECRET_ID}'"
            fi
            
            echo "æ£€æŸ¥COS_SECRET_KEY:"
            if [ -n "${COS_SECRET_KEY}" ]; then
              echo "  âœ… COS_SECRET_KEY: ${COS_SECRET_KEY:0:5}*** (é•¿åº¦: ${#COS_SECRET_KEY})"
            else
              echo "  âŒ COS_SECRET_KEY: æœªè®¾ç½®æˆ–ä¸ºç©º"
              echo "  è¯¦ç»†ä¿¡æ¯: '${COS_SECRET_KEY}'"
            fi
            
            echo "æ£€æŸ¥COS_BUCKET:"
            if [ -n "${COS_BUCKET}" ]; then
              echo "  âœ… COS_BUCKET: ${COS_BUCKET}"
            else
              echo "  âŒ COS_BUCKET: æœªè®¾ç½®æˆ–ä¸ºç©º"
              echo "  è¯¦ç»†ä¿¡æ¯: '${COS_BUCKET}'"
              echo "  å­—ç¬¦æ•°: ${#COS_BUCKET}"
              echo "  åå…­è¿›åˆ¶è¾“å‡º: $(echo -n "${COS_BUCKET}" | xxd)"
            fi
            
            echo "æ£€æŸ¥COS_REGION:"
            if [ -n "${COS_REGION}" ]; then
              echo "  âœ… COS_REGION: ${COS_REGION}"
            else
              echo "  âŒ COS_REGION: æœªè®¾ç½®æˆ–ä¸ºç©º"
              echo "  è¯¦ç»†ä¿¡æ¯: '${COS_REGION}'"
              echo "  å­—ç¬¦æ•°: ${#COS_REGION}"
              echo "  åå…­è¿›åˆ¶è¾“å‡º: $(echo -n "${COS_REGION}" | xxd)"
            fi
            
            echo "=== å®¹å™¨å†…ç¯å¢ƒå˜é‡å…¨æ‰«æ ==="
            echo "æ‰€æœ‰COSç›¸å…³å˜é‡:"
            env | grep -i cos || echo "æœªæ‰¾åˆ°COSç›¸å…³ç¯å¢ƒå˜é‡"
            
            echo "=== å˜é‡å¯¼å…¥è¯Šæ–­ ==="
            echo "CNBç¯å¢ƒå˜é‡å¯¼å…¥é…ç½®æµ‹è¯•..."
            
            # æ£€æŸ¥å¿…è¦ç¯å¢ƒå˜é‡
            missing_vars=""
            [ -z "$COS_SECRET_ID" ] && missing_vars="$missing_vars COS_SECRET_ID"
            [ -z "$COS_SECRET_KEY" ] && missing_vars="$missing_vars COS_SECRET_KEY"
            [ -z "$COS_BUCKET" ] && missing_vars="$missing_vars COS_BUCKET"
            [ -z "$COS_REGION" ] && missing_vars="$missing_vars COS_REGION"
            
            if [ -n "$missing_vars" ]; then
              echo "âŒ ç¯å¢ƒå˜é‡ç¼ºå¤±ï¼"
              echo "ç¼ºå¤±çš„å˜é‡:$missing_vars"
              echo "è¯·æ£€æŸ¥CNBå¯†é’¥ä»“åº“é…ç½®: https://cnb.cool/l-souljourney/env"
              echo "è¯·æ£€æŸ¥ç¯å¢ƒå˜é‡å¯¼å…¥è·¯å¾„: https://cnb.cool/l-souljourney/env/-/raw/main/env.yml"
              exit 1
            else
              echo "âœ… æ‰€æœ‰COSç¯å¢ƒå˜é‡å·²æ­£ç¡®è®¾ç½®"
            fi
            
            # é…ç½®coscliè®¤è¯
            echo "=== é…ç½®COSè®¤è¯ ==="
            coscli config set --secret_id "$COS_SECRET_ID" --secret_key "$COS_SECRET_KEY" 
            coscli config add --init-skip=true -b "$COS_BUCKET" -r "$COS_REGION"
            
            # éªŒè¯é…ç½®
            echo "=== éªŒè¯COSé…ç½® ==="
            coscli config show
            
            # æ˜¾ç¤ºæ„å»ºäº§ç‰©
            echo "=== æ„å»ºäº§ç‰©ä¿¡æ¯ ==="
            echo "æ„å»ºäº§ç‰©ç›®å½•å†…å®¹ï¼š"
            ls -la dist/
            echo "æ„å»ºäº§ç‰©å¤§å°ï¼š"
            du -sh dist/
            
            # ä¸Šä¼ åˆ°COS
            echo "=== å¼€å§‹ä¸Šä¼ åˆ°COS ==="
            coscli cp dist/ cos://$COS_BUCKET/ -r --exclude "./.git/*"
            
            # éªŒè¯ä¸Šä¼ ç»“æœ
            echo "=== éªŒè¯ä¸Šä¼ ç»“æœ ==="
            coscli ls cos://$COS_BUCKET/ | head -10
            
            echo "âœ… COSéƒ¨ç½²å®Œæˆ"
            echo "ğŸŒ ç½‘ç«™å·²æ›´æ–°åˆ°ç”Ÿäº§ç¯å¢ƒ"

# å¼€å‘åˆ†æ”¯ï¼šä»…æ„å»ºæµ‹è¯•
develop:
  push:
    - docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: setup environment
          script: |
            echo "ğŸš€ å¼€å§‹ç¯å¢ƒå‡†å¤‡..."
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
            
        - name: install dependencies
          script: |
            echo "ğŸ“¦ å¼€å§‹å®‰è£…ä¾èµ–..."
            time pnpm install --frozen-lockfile
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            
        - name: build test
          script: |
            echo "ğŸ—ï¸ å¼€å§‹æ„å»ºæµ‹è¯•..."
            time pnpm run build
            echo "ğŸ“Š æ„å»ºäº§ç‰©å¤§å°:"
            du -sh dist/
            ls -la dist/ | head -10
            echo "âœ… æ„å»ºæµ‹è¯•å®Œæˆ"

# Pull Requestï¼šå¿«é€Ÿæ„å»ºæ£€æŸ¥
pull_request:
  - docker:
      image: node:18-alpine
      volumes:
        - node_modules:copy-on-write
        - /root/.local/share/pnpm:copy-on-write
        - /root/.cache/pnpm:copy-on-write
    stages:
      - name: quick check
        script: |
          echo "âš¡ å¼€å§‹å¿«é€Ÿæ£€æŸ¥..."
          npm install -g pnpm@latest
          pnpm config set registry https://mirrors.cloud.tencent.com/npm/
          time pnpm install --frozen-lockfile
          time pnpm run build
          echo "âœ… å¿«é€Ÿæ£€æŸ¥å®Œæˆ" 