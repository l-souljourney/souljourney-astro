# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢é¡¹ç›®

main:
  push:
    name: ä¸»åˆ†æ”¯éƒ¨ç½²æµæ°´çº¿
    env:
      TZ: Asia/Shanghai
    image: node:18-alpine
    stages:
      - name: ç¯å¢ƒå‡†å¤‡
        script: |
          echo "ğŸ”§ === ç¯å¢ƒå‡†å¤‡ ==="
          node --version
          npm --version
          echo "å®‰è£…pnpm..."
          npm install -g pnpm
          pnpm --version
          echo "ç¯å¢ƒå‡†å¤‡å®Œæˆ âœ…"
          
      - name: å®‰è£…ä¾èµ–
        script: |
          echo "ğŸ“¦ === å®‰è£…é¡¹ç›®ä¾èµ– ==="
          pnpm config set registry https://registry.npmmirror.com
          pnpm install --frozen-lockfile
          echo "ä¾èµ–å®‰è£…å®Œæˆ âœ…"
          
      - name: æ„å»ºé¡¹ç›®
        script: |
          echo "ğŸ—ï¸ === æ„å»ºAstroé¡¹ç›® ==="
          pnpm build
          echo "=== æ„å»ºäº§ç‰©æ£€æŸ¥ ==="
          ls -la dist/
          echo "æ–‡ä»¶æ€»æ•°: $(find dist -type f | wc -l)"
          echo "æ„å»ºå®Œæˆ âœ…"
          
      - name: éƒ¨ç½²åˆ°COS
        image: cnbcool/tencent-cos
        script: |
          echo "ğŸš€ === éƒ¨ç½²åˆ°è…¾è®¯äº‘COS ==="
          plugin-deploy
          echo "COSéƒ¨ç½²å®Œæˆ âœ…"
          
      - name: åˆ·æ–°CDN
        image: cnbcool/tencent-cdn
        script: |
          echo "ğŸ”„ === åˆ·æ–°CDNç¼“å­˜ ==="
          plugin-refresh
          echo "CDNåˆ·æ–°å®Œæˆ âœ…"
          
      - name: åŒæ­¥GitHub
        script: |
          echo "ğŸ“¤ === åŒæ­¥åˆ°GitHub ==="
          if [ -n "$GITHUB_TOKEN" ]; then
            apk add --no-cache git
            git config --global user.email "cnb@l-souljourney.cn"
            git config --global user.name "CNB Deploy"
            git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git 2>/dev/null || true
            git remote set-url github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git
            git push github main --force
            echo "GitHubåŒæ­¥å®Œæˆ âœ…"
          else
            echo "âš ï¸ æœªé…ç½®GITHUB_TOKENï¼Œè·³è¿‡åŒæ­¥"
          fi

develop:
  push:
    name: å¼€å‘åˆ†æ”¯æµ‹è¯•æµæ°´çº¿
    env:
      TZ: Asia/Shanghai
    image: node:18-alpine
    stages:
      - name: æ„å»ºæµ‹è¯•
        script: |
          echo "ğŸ§ª === å¼€å‘åˆ†æ”¯æ„å»ºæµ‹è¯• ==="
          npm install -g pnpm
          pnpm config set registry https://registry.npmmirror.com
          pnpm install --frozen-lockfile
          pnpm build
          echo "âœ… æ„å»ºæµ‹è¯•é€šè¿‡"

'**':
  pull_request:
    name: PRæ„å»ºæ£€æŸ¥
    env:
      TZ: Asia/Shanghai
    image: node:18-alpine
    stages:
      - name: PRæ£€æŸ¥
        script: |
          echo "ğŸ” === PRæ„å»ºæ£€æŸ¥ ==="
          npm install -g pnpm
          pnpm config set registry https://registry.npmmirror.com
          pnpm install --frozen-lockfile
          pnpm build
          echo "âœ… PRæ£€æŸ¥é€šè¿‡"
