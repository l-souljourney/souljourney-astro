# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢é¡¹ç›®

main:
  push:
    name: ä¸»åˆ†æ”¯éƒ¨ç½²æµæ°´çº¿
    env:
      TZ: Asia/Shanghai
      NODE_ENV: production
    image: node:18-alpine
    script: |
      echo "ğŸ”§ === ç¯å¢ƒå‡†å¤‡ ==="
      node --version
      npm --version
      echo "å®‰è£…pnpm..."
      npm install -g pnpm
      pnpm --version
      echo "ç¯å¢ƒå‡†å¤‡å®Œæˆ âœ…"
      
      echo "ğŸ“¦ === å®‰è£…é¡¹ç›®ä¾èµ– ==="
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      echo "ä¾èµ–å®‰è£…å®Œæˆ âœ…"
      
      echo "ğŸ—ï¸ === æ„å»ºAstroé¡¹ç›® ==="
      pnpm build
      echo "=== æ„å»ºäº§ç‰©æ£€æŸ¥ ==="
      ls -la dist/
      echo "æ–‡ä»¶æ€»æ•°: $(find dist -type f | wc -l)"
      echo "æ„å»ºå®Œæˆ âœ…"
      
      echo "ğŸš€ === éƒ¨ç½²åˆ°è…¾è®¯äº‘COS ==="
      echo "ä½¿ç”¨COSæ’ä»¶éƒ¨ç½²..."
    plugins:
      - name: cnbcool/tencent-cos
        with:
          secret_id: ${COS_SECRET_ID}
          secret_key: ${COS_SECRET_KEY}
          bucket: ${COS_BUCKET}
          region: ${COS_REGION}
          src: dist/
          dest: /
          delete: true
          exclude: |
            *.tmp
            .DS_Store
      - name: cnbcool/tencent-cdn
        if: env.CDN_DOMAIN
        with:
          secret_id: ${COS_SECRET_ID}
          secret_key: ${COS_SECRET_KEY}
          domain: ${CDN_DOMAIN}
          type: purge
          urls: |
            https://${CDN_DOMAIN}/
            https://${CDN_DOMAIN}/index.html
      - name: github-sync
        if: env.GITHUB_TOKEN
        script: |
          echo "ğŸ“¤ === åŒæ­¥åˆ°GitHub ==="
          git config --global user.name "CNB Deploy Bot"
          git config --global user.email "noreply@cnb.cool"
          git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git || true
          git push github main --force
          echo "GitHubåŒæ­¥å®Œæˆ âœ…"

develop:
  push:
    name: å¼€å‘åˆ†æ”¯æµ‹è¯•æµæ°´çº¿
    env:
      TZ: Asia/Shanghai
      NODE_ENV: development
    image: node:18-alpine
    script: |
      echo "ğŸ§ª === å¼€å‘ç¯å¢ƒæ„å»ºæµ‹è¯• ==="
      node --version
      npm --version
      npm install -g pnpm
      pnpm --version
      
      echo "ğŸ“¦ === å®‰è£…ä¾èµ– ==="
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      
      echo "ğŸ—ï¸ === æ„å»ºæµ‹è¯• ==="
      pnpm build
      ls -la dist/
      echo "å¼€å‘ç¯å¢ƒæ„å»ºæµ‹è¯•å®Œæˆ âœ…"

"**":
  pull_request:
    name: PRæ„å»ºæ£€æŸ¥
    env:
      TZ: Asia/Shanghai
    image: node:18-alpine
    script: |
      echo "ğŸ” === PRæ„å»ºæ£€æŸ¥ ==="
      node --version
      npm install -g pnpm
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      pnpm build
      echo "PRæ£€æŸ¥å®Œæˆ âœ…"

"$":
  push:
    name: é»˜è®¤åˆ†æ”¯æ„å»º
    env:
      TZ: Asia/Shanghai
    image: node:18-alpine
    script: |
      echo "ğŸ”§ === åŸºç¡€æ„å»ºæµ‹è¯• ==="
      node --version
      npm install -g pnpm
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      pnpm build
      echo "åŸºç¡€æ„å»ºå®Œæˆ âœ…"
