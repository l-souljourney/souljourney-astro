# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢ - åŒçº¿éƒ¨ç½²æ–¹æ¡ˆ

# ä¸»åˆ†æ”¯æ„å»ºé…ç½®
main:
  push:
    - imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      env:
        TZ: Asia/Shanghai
      
      stages:
        # é˜¶æ®µ1: ç¯å¢ƒå‡†å¤‡
        - name: setup-environment
          script: |
            echo "ğŸ”§ === ç¯å¢ƒå‡†å¤‡ ==="
            node --version
            npm --version
            echo "å¼€å§‹å®‰è£…pnpm..."
            npm install -g pnpm
            pnpm --version
            echo "ç¯å¢ƒå‡†å¤‡å®Œæˆ âœ…"
            
        # é˜¶æ®µ2: å®‰è£…ä¾èµ–
        - name: install-dependencies
          script: |
            echo "ğŸ“¦ === å®‰è£…é¡¹ç›®ä¾èµ– ==="
            pnpm config set registry https://registry.npmmirror.com
            pnpm install --frozen-lockfile
            echo "ä¾èµ–å®‰è£…å®Œæˆ âœ…"
            
        # é˜¶æ®µ3: æ„å»ºé¡¹ç›®
        - name: build-project
          script: |
            echo "ğŸ—ï¸ === å¼€å§‹æ„å»ºAstroé¡¹ç›® ==="
            pnpm build
            echo "=== æ„å»ºäº§ç‰©æ£€æŸ¥ ==="
            ls -la dist/
            echo "æ–‡ä»¶æ€»æ•°: $(find dist -type f | wc -l)"
            echo "æ„å»ºç›®å½•å¤§å°: $(du -sh dist/)"
            echo "é¡¹ç›®æ„å»ºå®Œæˆ âœ…"
            
        # é˜¶æ®µ4: éƒ¨ç½²åˆ°è…¾è®¯äº‘COS
        - name: deploy-to-cos
          script: |
            echo "ğŸš€ === å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘COS ==="
            
            # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
            if [ -z "$COS_SECRET_ID" ] || [ -z "$COS_SECRET_KEY" ] || [ -z "$COS_BUCKET" ]; then
              echo "âŒ ç¼ºå°‘å¿…è¦çš„COSç¯å¢ƒå˜é‡"
              echo "è¯·ç¡®ä¿åœ¨å¯†é’¥ä»“åº“ä¸­é…ç½®:"
              echo "- COS_SECRET_ID"
              echo "- COS_SECRET_KEY" 
              echo "- COS_BUCKET"
              exit 1
            fi
            
            # å®‰è£…è…¾è®¯äº‘CLIå·¥å…·
            pip3 install coscmd
            
            # é…ç½®COS
            coscmd config -a $COS_SECRET_ID -s $COS_SECRET_KEY -b $COS_BUCKET -r ap-guangzhou
            
            # åŒæ­¥æ–‡ä»¶åˆ°COS (åˆ é™¤è¿œç¨‹å¤šä½™æ–‡ä»¶)
            coscmd upload -r -s --delete ./dist/ /
            
            echo "COSéƒ¨ç½²å®Œæˆ âœ…"
            
        # é˜¶æ®µ5: åˆ·æ–°CDNç¼“å­˜
        - name: refresh-cdn
          script: |
            echo "ğŸ”„ === åˆ·æ–°CDNç¼“å­˜ ==="
            echo "ğŸ’¡ CDNç¼“å­˜å°†åœ¨å‡ åˆ†é’Ÿå†…è‡ªåŠ¨æ›´æ–°"
            echo "å¦‚éœ€ç«‹å³åˆ·æ–°ï¼Œè¯·æ‰‹åŠ¨åœ¨è…¾è®¯äº‘CDNæ§åˆ¶å°æ“ä½œ"
            echo "CDNç¼“å­˜å¤„ç†å®Œæˆ âœ…"
            
        # é˜¶æ®µ6: åŒæ­¥åˆ°GitHub
        - name: sync-to-github
          script: |
            echo "ğŸ“¤ === åŒæ­¥åˆ°GitHubä»“åº“ ==="
            
            # æ£€æŸ¥GitHub Token
            if [ -z "$GITHUB_TOKEN" ]; then
              echo "âš ï¸ æœªé…ç½®GITHUB_TOKENï¼Œè·³è¿‡GitHubåŒæ­¥"
              echo "ğŸ’¡ è¯·åœ¨CNBå¯†é’¥ä»“åº“ä¸­é…ç½®GITHUB_TOKENç¯å¢ƒå˜é‡"
              exit 0
            fi
            
            # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
            git config --global user.email "cnb-deploy@l-souljourney.cn"
            git config --global user.name "CNB Auto Deploy"
            
            # æ·»åŠ GitHubè¿œç¨‹ä»“åº“
            echo "ğŸ“¡ é…ç½®GitHubè¿œç¨‹ä»“åº“..."
            git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git 2>/dev/null || true
            git remote set-url github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git
            
            # æ¨é€åˆ°GitHub
            echo "ğŸ“¤ æ¨é€åˆ°GitHubä»“åº“..."
            git push github main --force
            
            echo "âœ… GitHubåŒæ­¥å®Œæˆï¼"
            echo "ğŸš€ Cloudflare Pageså°†è‡ªåŠ¨æ£€æµ‹å˜æ›´å¹¶æ„å»º"

# developåˆ†æ”¯æ„å»ºé…ç½®ï¼ˆä»…æ„å»ºæµ‹è¯•ï¼Œä¸éƒ¨ç½²ï¼‰
develop:
  push:
    - imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      env:
        TZ: Asia/Shanghai
      
      stages:
        - name: test-build
          script: |
            echo "ğŸ§ª === å¼€å‘åˆ†æ”¯æ„å»ºæµ‹è¯• ==="
            
            # å®‰è£…ä¾èµ–
            npm install -g pnpm
            pnpm config set registry https://registry.npmmirror.com
            pnpm install --frozen-lockfile
            
            # æ„å»ºæµ‹è¯•
            pnpm build
            
            echo "âœ… å¼€å‘åˆ†æ”¯æ„å»ºæµ‹è¯•é€šè¿‡"
            echo "ğŸ’¡ åˆå¹¶åˆ°mainåˆ†æ”¯åå°†è‡ªåŠ¨éƒ¨ç½²"
