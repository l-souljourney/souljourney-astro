# è…¾è®¯äº‘ CNB (Cloud Native Builder) æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢åŒçº¿éƒ¨ç½²é…ç½®

# æ„å»ºé…ç½®
build:
  # æ„å»ºç¯å¢ƒ
  runtime: nodejs18
  
  # å·¥ä½œç›®å½•
  workdir: /workspace
  
  # æ„å»ºé˜¶æ®µ
  stages:
    # ç¯å¢ƒå‡†å¤‡é˜¶æ®µ
    - name: setup
      commands:
        - echo "ğŸš€ å¼€å§‹æ„å»º L-Souljourney åšå®¢..."
        - echo "ğŸ“¦ å®‰è£… pnpm åŒ…ç®¡ç†å™¨..."
        - npm install -g pnpm@latest
        - node --version
        - npm --version
        - pnpm --version
        
    # ä¾èµ–å®‰è£…é˜¶æ®µ
    - name: install
      commands:
        - echo "ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–..."
        - pnpm install --frozen-lockfile
        - echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    # æ„å»ºé˜¶æ®µ
    - name: build
      commands:
        - echo "ğŸ”¨ å¼€å§‹æ„å»º Astro é¡¹ç›®..."
        - pnpm build
        - echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
        - ls -la dist/
        - du -sh dist/
        - find dist -type f | wc -l | xargs echo "æ–‡ä»¶æ•°é‡:"
        - echo "âœ… æ„å»ºå®Œæˆ"

# éƒ¨ç½²é…ç½®
deploy:
  # éƒ¨ç½²åˆ°è…¾è®¯äº‘ COS
  cos:
    # COS å­˜å‚¨æ¡¶é…ç½®
    bucket: "souljourney-1251969283"
    region: "ap-shanghai"
    
    # ä¸Šä¼ é…ç½®
    upload:
      # æœ¬åœ°æ„å»ºäº§ç‰©è·¯å¾„
      source: "./dist/"
      # COS ç›®æ ‡è·¯å¾„
      target: "/"
      # åŒæ­¥æ¨¡å¼ï¼šåˆ é™¤è¿œç¨‹å¤šä½™æ–‡ä»¶
      sync: true
      # å¿½ç•¥çš„æ–‡ä»¶
      exclude:
        - "*.map"
        - "*.log"
        - ".DS_Store"
        
    # æ–‡ä»¶ç±»å‹é…ç½®
    headers:
      # HTML æ–‡ä»¶
      "*.html":
        content-type: "text/html; charset=utf-8"
        cache-control: "public, max-age=3600"
      # CSS æ–‡ä»¶
      "*.css":
        content-type: "text/css; charset=utf-8"
        cache-control: "public, max-age=31536000"
      # JS æ–‡ä»¶
      "*.js":
        content-type: "application/javascript; charset=utf-8"
        cache-control: "public, max-age=31536000"
      # å›¾ç‰‡æ–‡ä»¶
      "*.{jpg,jpeg,png,gif,webp,svg,ico}":
        cache-control: "public, max-age=31536000"
      # å­—ä½“æ–‡ä»¶
      "*.{woff,woff2,ttf,eot}":
        cache-control: "public, max-age=31536000"
        
  # CDN åˆ·æ–°é…ç½®
  cdn:
    # æ˜¯å¦è‡ªåŠ¨åˆ·æ–° CDN
    refresh: true
    # åˆ·æ–°è·¯å¾„
    paths:
      - "/*"
    # åˆ·æ–°ç±»å‹ï¼šflush(åˆ·æ–°) æˆ– prefetch(é¢„çƒ­)
    type: "flush"

# ç¯å¢ƒå˜é‡
environment:
  # Node.js ç¯å¢ƒ
  NODE_ENV: "production"
  NODE_OPTIONS: "--max_old_space_size=4096"
  # æ„å»ºä¼˜åŒ–
  ASTRO_TELEMETRY_DISABLED: "1"
  # æ—¶åŒºè®¾ç½®
  TZ: "Asia/Shanghai"

# æ„å»ºåè„šæœ¬
post_build:
  commands:
    - echo "ğŸ”„ å¼€å§‹åŒæ­¥åˆ° GitHub..."
    # é…ç½® Git
    - git config --global user.email "cnb-deploy@l-souljourney.cn"
    - git config --global user.name "CNB Auto Deploy"
    - git config --global init.defaultBranch main
    
    # æ£€æŸ¥ç¯å¢ƒå˜é‡
    - |
      if [ -z "$GITHUB_TOKEN" ]; then
        echo "âš ï¸  GITHUB_TOKEN ç¯å¢ƒå˜é‡æœªè®¾ç½®ï¼Œè·³è¿‡åŒæ­¥åˆ° GitHub"
        exit 0
      fi
      
    # åŒæ­¥åˆ° GitHubï¼ˆè§¦å‘ Cloudflare Pagesï¼‰
    - |
      echo "ğŸ“¤ æ¨é€åˆ° GitHub ä»“åº“..."
      git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git || true
      git remote set-url github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git
      git push github main --force
      
    - echo "âœ… åŒæ­¥åˆ° GitHub å®Œæˆ"
    
    # éƒ¨ç½²æˆåŠŸé€šçŸ¥
    - echo "ğŸ‰ åšå®¢éƒ¨ç½²æˆåŠŸï¼"
    - echo "ğŸŒ å›½å†…è®¿é—®: https://blog.l-souljourney.cn"
    - echo "ğŸŒ æµ·å¤–è®¿é—®: ç­‰å¾… Cloudflare Pages æ„å»ºå®Œæˆ"
    - echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²ç»Ÿè®¡:"
    - echo "   - æ„å»ºæ—¶é—´: $(date)"
    - echo "   - Git æäº¤: $CNB_GIT_COMMIT_SHA"
    - echo "   - åˆ†æ”¯: $CNB_GIT_REF"

# è§¦å‘æ¡ä»¶
triggers:
  # Git æ¨é€è§¦å‘
  git:
    # ç›‘å¬çš„åˆ†æ”¯
    branches:
      - main
    # å¿½ç•¥çš„è·¯å¾„ï¼ˆè¿™äº›æ–‡ä»¶å˜æ›´ä¸è§¦å‘æ„å»ºï¼‰
    ignore_paths:
      - "README.md"
      - "*.md"
      - ".gitignore"
      - "LICENSE"
      - ".github/**"
    # åªæœ‰è¿™äº›è·¯å¾„å˜æ›´æ‰è§¦å‘æ„å»º
    include_paths:
      - "src/**"
      - "public/**"
      - "package.json"
      - "pnpm-lock.yaml"
      - "astro.config.mjs"
      - "tsconfig.json"

# ç¼“å­˜é…ç½®
cache:
  # ç¼“å­˜è·¯å¾„
  paths:
    - "node_modules"
    - ".pnpm-store"
    - "dist"
  # ç¼“å­˜é”®
  key: "pnpm-cache-{{ checksum 'pnpm-lock.yaml' }}"

# æ„å»ºèµ„æºé™åˆ¶
resources:
  # CPU é™åˆ¶ (æ ¸æ•°)
  cpu: 2
  # å†…å­˜é™åˆ¶ (MB)
  memory: 4096
  # æ„å»ºè¶…æ—¶ (åˆ†é’Ÿ)
  timeout: 30

# é€šçŸ¥é…ç½® (å¯é€‰)
notifications:
  # æ„å»ºæˆåŠŸé€šçŸ¥
  success:
    - type: webhook
      url: "$WEBHOOK_SUCCESS_URL"  # ä»ç¯å¢ƒå˜é‡è¯»å–
  # æ„å»ºå¤±è´¥é€šçŸ¥  
  failure:
    - type: webhook
      url: "$WEBHOOK_FAILURE_URL"  # ä»ç¯å¢ƒå˜é‡è¯»å–

# æ—¥å¿—é…ç½®
logging:
  level: info
  format: json 