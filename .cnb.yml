# è…¾è®¯äº‘ CNB (Cloud Native Builder) æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢ç®€åŒ–éƒ¨ç½²é…ç½®

# ä¸»åˆ†æ”¯ - ç”Ÿäº§éƒ¨ç½²
main:
  push:
    - name: astro-blog-deploy
      image: node:18
      # ä»å¯†é’¥ä»“åº“å¯¼å…¥æ•æ„Ÿç¯å¢ƒå˜é‡
      # imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      env:
        NODE_ENV: production
        ASTRO_TELEMETRY_DISABLED: "1"
        TZ: Asia/Shanghai
        # è…¾è®¯äº‘COSé…ç½®
        COS_BUCKET: "souljourney-1251969283"
        COS_REGION: "ap-shanghai"
      
      script: |
        echo "ğŸš€ å¼€å§‹æ„å»º L-Souljourney åšå®¢..."
        
        # ç¯å¢ƒä¿¡æ¯
        echo "ğŸ“‹ ç¯å¢ƒä¿¡æ¯:"
        node --version
        npm --version
        
        # å®‰è£… pnpm
        echo "ğŸ“¦ å®‰è£… pnpm åŒ…ç®¡ç†å™¨..."
        npm install -g pnpm@latest
        pnpm --version
        
        # å®‰è£…ä¾èµ–
        echo "ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–..."
        pnpm install --frozen-lockfile
        
        # æ„å»ºé¡¹ç›®
        echo "ğŸ”¨ æ„å»º Astro é¡¹ç›®..."
        pnpm build
        
        # æ˜¾ç¤ºæ„å»ºç»“æœ
        echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
        ls -la dist/
        du -sh dist/
        find dist -type f | wc -l | xargs echo "æ–‡ä»¶æ•°é‡:"
        
        # æ£€æŸ¥COSç¯å¢ƒå˜é‡
        if [ -n "$COS_SECRET_ID" ] && [ -n "$COS_SECRET_KEY" ]; then
          echo "ğŸ”§ æ£€æµ‹åˆ°COSé…ç½®ï¼Œå‡†å¤‡ä¸Šä¼ ..."
          
          # å®‰è£… Python å’Œ coscmd å·¥å…·
          apt-get update && apt-get install -y python3 python3-pip
          pip3 install coscmd
          
          # é…ç½® coscmd
          coscmd config -a $COS_SECRET_ID -s $COS_SECRET_KEY -b $COS_BUCKET -r $COS_REGION
          
          # ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°COS
          echo "ğŸ“¤ ä¸Šä¼ æ–‡ä»¶åˆ°è…¾è®¯äº‘COS..."
          coscmd upload -r -s --delete ./dist/ /
          
          echo "âœ… åšå®¢éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸŒ è®¿é—®åœ°å€: https://blog.l-souljourney.cn"
        else
          echo "âš ï¸  æœªé…ç½®COSç¯å¢ƒå˜é‡ï¼Œè·³è¿‡ä¸Šä¼ æ­¥éª¤"
          echo "ğŸ’¡ è¯·åœ¨CNBé¡¹ç›®è®¾ç½®ä¸­é…ç½® COS_SECRET_ID å’Œ COS_SECRET_KEY ç¯å¢ƒå˜é‡"
        fi

# å¼€å‘åˆ†æ”¯ - ä»…æ„å»ºæµ‹è¯•
develop:
  push:
    - name: astro-blog-test
      image: node:18
      env:
        NODE_ENV: development
        ASTRO_TELEMETRY_DISABLED: "1"
      
      script: |
        echo "ğŸ§ª å¼€å‘åˆ†æ”¯æ„å»ºæµ‹è¯•..."
        
        # å®‰è£…ä¾èµ–å¹¶æ„å»º
        npm install -g pnpm@latest
        pnpm install --frozen-lockfile
        pnpm build
        
        echo "âœ… å¼€å‘æ„å»ºæµ‹è¯•å®Œæˆï¼"

# Pull Request - ä»£ç æ£€æŸ¥
"**":
  pull_request:
    - name: pr-check
      image: node:18
      script: |
        echo "ğŸ” PR æ„å»ºæ£€æŸ¥..."
        npm install -g pnpm@latest
        pnpm install --frozen-lockfile
        pnpm build
        echo "âœ… PR æ„å»ºæ£€æŸ¥é€šè¿‡" 