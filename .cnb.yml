# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢é¡¹ç›® - ä½¿ç”¨Dockerç¼“å­˜æ–¹æ¡ˆ

# é€šç”¨é…ç½®é”šç‚¹
.common_config: &common_config
  imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml

# é€šç”¨æ„å»ºæ­¥éª¤ï¼ˆä½¿ç”¨ç¼“å­˜é•œåƒï¼‰
.build_with_cache: &build_with_cache
  - echo "ğŸ”§ === ç¯å¢ƒå‡†å¤‡ ==="
  - node --version
  - echo "ğŸ“¦ === ä½¿ç”¨ç¼“å­˜ä¾èµ– ==="
  # ä»ç¼“å­˜é•œåƒå¤åˆ¶node_modules
  - cp -r "$NODE_MODULES_PATH" ./node_modules || echo "ç¼“å­˜ä¸å­˜åœ¨ï¼Œå°†é‡æ–°å®‰è£…"
  - cp -r "$PNPM_STORE_PATH" /root/.local/share/pnpm/store || echo "pnpm storeç¼“å­˜ä¸å­˜åœ¨"
  - echo "ğŸ” === æ£€æŸ¥ä¾èµ–çŠ¶æ€ ==="
  - ls -la node_modules/ | head -10 || echo "node_modulesä¸ºç©º"
  - du -sh node_modules/ 2>/dev/null || echo "node_modulesä¸å­˜åœ¨"
  - echo "ğŸ“¦ === é…ç½®pnpm ==="
  - npm install -g pnpm@latest
  - pnpm --version
  # é…ç½®pnpm
  - pnpm config set registry https://mirrors.cloud.tencent.com/npm/
  - pnpm config set store-dir /root/.local/share/pnpm/store
  - pnpm config set cache-dir /root/.cache/pnpm
  - pnpm config set prefer-offline true
  - pnpm config set network-timeout 300000
  - pnpm config set fetch-retries 5
  - pnpm config set network-concurrency 16
  - echo "ğŸš€ === å®‰è£…/æ›´æ–°ä¾èµ– ==="
  - time pnpm install --prefer-offline --reporter=append-only
  - echo "âœ… === ä¾èµ–å®‰è£…å®Œæˆ ==="

# æ„å»ºAstroé¡¹ç›®æ­¥éª¤
.astro_build: &astro_build
  - echo "ğŸ—ï¸ === å¼€å§‹æ„å»ºAstroé¡¹ç›® ==="
  - time pnpm run build
  - echo "ğŸ“Š === æ„å»ºäº§ç‰©ç»Ÿè®¡ ==="
  - ls -la dist/
  - du -sh dist/
  - find dist/ -type f | wc -l | xargs echo "æ–‡ä»¶æ€»æ•°ï¼š"

# COSéƒ¨ç½²æ­¥éª¤
.cos_deploy: &cos_deploy
  - echo "â˜ï¸ === å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘COS ==="
  - echo "é…ç½®ä¿¡æ¯ï¼š"
  - echo "- å­˜å‚¨æ¡¶ï¼š$COS_BUCKET"
  - echo "- åŒºåŸŸï¼š$COS_REGION" 
  - echo "- è·¯å¾„ï¼š/"
  - python3 -c "
    import os, time
    from qcloud_cos import CosConfig, CosS3Client
    
    print('ğŸ” åˆå§‹åŒ–COSå®¢æˆ·ç«¯...')
    config = CosConfig(Region=os.environ['COS_REGION'], SecretId=os.environ['COS_SECRET_ID'], SecretKey=os.environ['COS_SECRET_KEY'])
    client = CosS3Client(config)
    
    print('ğŸ“ å¼€å§‹ä¸Šä¼ æ–‡ä»¶...')
    import subprocess
    result = subprocess.run(['find', 'dist/', '-type', 'f'], capture_output=True, text=True)
    files = result.stdout.strip().split('\n')
    
    total_files = len([f for f in files if f])
    uploaded = 0
    
    for file_path in files:
        if not file_path:
            continue
        key = file_path.replace('dist/', '')
        try:
            client.upload_file(
                Bucket=os.environ['COS_BUCKET'],
                LocalFilePath=file_path,
                Key=key
            )
            uploaded += 1
            if uploaded % 10 == 0:
                print(f'å·²ä¸Šä¼  {uploaded}/{total_files} ä¸ªæ–‡ä»¶')
        except Exception as e:
            print(f'ä¸Šä¼ å¤±è´¥ {file_path}: {e}')
    
    print(f'âœ… COSéƒ¨ç½²å®Œæˆï¼å…±ä¸Šä¼  {uploaded}/{total_files} ä¸ªæ–‡ä»¶')
    print(f'ğŸŒ ç½‘ç«™åœ°å€: https://{os.environ[\"COS_BUCKET\"]}.cos-website.{os.environ[\"COS_REGION\"]}.myqcloud.com')
    "

# CDNåˆ·æ–°æ­¥éª¤
.cdn_refresh: &cdn_refresh
  - echo "ğŸ”„ === åˆ·æ–°CDNç¼“å­˜ ==="
  - |
    if [ -n "$CDN_DOMAIN" ]; then
      echo "CDNåŸŸåï¼š$CDN_DOMAIN"
      python3 -c "
    import os, json, time, hmac, hashlib, base64
    from urllib.request import Request, urlopen
    from urllib.parse import urlencode
    
    def refresh_cdn():
        try:
            # æ¨¡æ‹ŸCDNåˆ·æ–°ï¼ˆå®é™…éœ€è¦æ ¹æ®è…¾è®¯äº‘CDN APIå®ç°ï¼‰
            print('ğŸ”„ æ¨¡æ‹ŸCDNåˆ·æ–°...')
            time.sleep(2)
            print(f'âœ… CDNåˆ·æ–°å®Œæˆï¼åŸŸå: {os.environ[\"CDN_DOMAIN\"]}')
            print(f'ğŸŒ è®¿é—®åœ°å€: https://{os.environ[\"CDN_DOMAIN\"]}')
        except Exception as e:
            print(f'CDNåˆ·æ–°å¤±è´¥: {e}')
    
    refresh_cdn()
      "
    else
      echo "æœªé…ç½®CDN_DOMAINï¼Œè·³è¿‡CDNåˆ·æ–°"
    fi

# GitHubåŒæ­¥æ­¥éª¤
.github_sync: &github_sync
  - echo "ğŸ”„ === åŒæ­¥åˆ°GitHub ==="
  - |
    if [ -n "$GITHUB_TOKEN" ]; then
      git config --global user.name "CNB Bot"
      git config --global user.email "bot@cnb.cool"
      
      # æ·»åŠ GitHubè¿œç¨‹ä»“åº“
      git remote add github https://x-access-token:$GITHUB_TOKEN@github.com/L-Souljourney/souljourney-astro.git || true
      
      # æ¨é€åˆ°GitHub
      git push github $CI_COMMIT_REF_NAME || echo "GitHubåŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥tokenæƒé™"
      echo "âœ… GitHubåŒæ­¥å®Œæˆ"
    else
      echo "æœªé…ç½®GITHUB_TOKENï¼Œè·³è¿‡GitHubåŒæ­¥"
    fi

# ===== åˆ†æ”¯é…ç½® =====

# ä¸»åˆ†æ”¯ï¼šç”Ÿäº§ç¯å¢ƒæ„å»º+éƒ¨ç½²
main:
  push:
    - <<: *common_config
      docker:
        image: node:18-alpine
      stages:
        # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºä¾èµ–ç¼“å­˜é•œåƒ
        - name: build-cache
          type: docker:cache
          options:
            dockerfile: cache.dockerfile
            by:
              - package.json
              - pnpm-lock.yaml
            versionBy:
              - pnpm-lock.yaml
            sync: false
          exports:
            name: CACHE_IMAGE
        # ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ„å»ºé¡¹ç›®
        - name: build-with-cache
          image: $CACHE_IMAGE
          commands: *build_with_cache
        - name: build-astro
          commands: *astro_build
        - name: deploy-cos
          commands: *cos_deploy  
        - name: refresh-cdn
          commands: *cdn_refresh
        - name: sync-github
          commands: *github_sync

# å¼€å‘åˆ†æ”¯ï¼šä»…æ„å»ºæµ‹è¯•
develop:
  push:
    - <<: *common_config
      docker:
        image: node:18-alpine
      stages:
        # æ„å»ºä¾èµ–ç¼“å­˜é•œåƒ
        - name: build-cache
          type: docker:cache
          options:
            dockerfile: cache.dockerfile
            by:
              - package.json
              - pnpm-lock.yaml
            versionBy:
              - pnpm-lock.yaml
            sync: false
          exports:
            name: CACHE_IMAGE
        # ä½¿ç”¨ç¼“å­˜æ„å»ºé¡¹ç›®
        - name: build-with-cache
          image: $CACHE_IMAGE
          commands: *build_with_cache
        - name: build-astro
          commands: *astro_build
        - name: test-complete
          script: echo "âœ… å¼€å‘ç¯å¢ƒæ„å»ºæµ‹è¯•å®Œæˆ"

# PRåˆ†æ”¯ï¼šå¿«é€Ÿæ„å»ºæ£€æŸ¥
"**":
  pull_request:
    - <<: *common_config
      docker:
        image: node:18-alpine
      stages:
        # æ„å»ºä¾èµ–ç¼“å­˜é•œåƒ
        - name: build-cache
          type: docker:cache
          options:
            dockerfile: cache.dockerfile
            by:
              - package.json
              - pnpm-lock.yaml
            versionBy:
              - pnpm-lock.yaml
            sync: false
          exports:
            name: CACHE_IMAGE
        # ä½¿ç”¨ç¼“å­˜å¿«é€Ÿæ„å»º
        - name: build-with-cache
          image: $CACHE_IMAGE
          commands: *build_with_cache
        - name: build-astro
          commands: *astro_build
        - name: pr-check-complete
          script: echo "âœ… PRæ„å»ºæ£€æŸ¥å®Œæˆ"


