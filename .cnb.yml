# CNB æ„å»ºé…ç½®æ–‡ä»¶ - ç²¾ç®€ç”Ÿäº§ç‰ˆæœ¬
# SoulJourneyBlog Astro æ„å»ºéƒ¨ç½²

# ä¸»åˆ†æ”¯ï¼šç”Ÿäº§ç¯å¢ƒæ„å»º+éƒ¨ç½²
main:
  push:
    - imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      env:
        TZ: Asia/Shanghai
      
      docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: build project
          script: |
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            pnpm install --frozen-lockfile
            pnpm run build
            echo "âœ… æ„å»ºå®Œæˆ: $(du -sh dist/ | cut -f1)"
            
        - name: deploy to github
          image: alpine/git:latest
          script: |
            if [ -z "${GITHUB_TOKEN}" ]; then
              echo "âš ï¸  è·³è¿‡GitHubæ¨é€"
              exit 0
            fi
            
            git config --global user.name "CNB Auto Deploy"
            git config --global user.email "cnb@l-souljourney.cn"
            git remote set-url origin "https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git"
            git push origin HEAD:main
            echo "âœ… GitHubæ¨é€å®Œæˆ"
            
        - name: deploy to cos
          image: tencentcom/coscli:latest
          script: |
            echo "ğŸ” å¼€å§‹COSéƒ¨ç½²æ£€æŸ¥..."
            echo "ğŸ“¦ æ£€æŸ¥æ„å»ºäº§ç‰©..."
            if [ ! -d "dist" ]; then
              echo "âŒ é”™è¯¯: distç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
              exit 1
            fi
            echo "âœ… distç›®å½•å­˜åœ¨: $(du -sh dist/ | cut -f1)"
            
            echo "ğŸ”‘ æ£€æŸ¥ç¯å¢ƒå˜é‡..."
            if [ -z "${COS_SECRET_ID}" ] || [ -z "${COS_SECRET_KEY}" ] || [ -z "${COS_BUCKET}" ] || [ -z "${COS_REGION}" ]; then
              echo "âŒ COSç¯å¢ƒå˜é‡ä¸å®Œæ•´"
              echo "   COS_SECRET_ID: ${COS_SECRET_ID:+å·²è®¾ç½®}${COS_SECRET_ID:-æœªè®¾ç½®}"
              echo "   COS_SECRET_KEY: ${COS_SECRET_KEY:+å·²è®¾ç½®}${COS_SECRET_KEY:-æœªè®¾ç½®}"
              echo "   COS_BUCKET: ${COS_BUCKET:+å·²è®¾ç½®}${COS_BUCKET:-æœªè®¾ç½®}"
              echo "   COS_REGION: ${COS_REGION:+å·²è®¾ç½®}${COS_REGION:-æœªè®¾ç½®}"
              exit 1
            fi
            echo "âœ… ç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"
            echo "   Bucket: ${COS_BUCKET}"
            echo "   Region: ${COS_REGION}"
            
            echo "âš™ï¸  é…ç½®COS CLI..."
            coscli config set --secret_id "${COS_SECRET_ID}" --secret_key "${COS_SECRET_KEY}" || {
              echo "âŒ COS CLIé…ç½®å¤±è´¥"
              exit 1
            }
            coscli config add --init-skip=true -b "${COS_BUCKET}" -r "${COS_REGION}" || {
              echo "âŒ COS Bucketé…ç½®å¤±è´¥"
              exit 1
            }
            echo "âœ… COS CLIé…ç½®å®Œæˆ"
            
            echo "ğŸš€ å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°COS..."
            coscli sync dist/ "cos://${COS_BUCKET}/" --delete --force --disable-crc64 --recursive || {
              echo "âŒ COSæ–‡ä»¶åŒæ­¥å¤±è´¥"
              exit 1
            }
            
            echo "âœ… COSéƒ¨ç½²å®Œæˆ"
            if [ -n "${CDN_DOMAIN}" ]; then
              echo "ğŸŒ è®¿é—®åœ°å€: https://${CDN_DOMAIN}"
            fi

        - name: refresh edgeone cache
          image: python:3.9-slim
          script: |
            echo "ğŸš€ å¼€å§‹åˆ·æ–° EdgeOne ç¼“å­˜..."
            
            # 1. æ£€æŸ¥å¿…è¦å˜é‡
            if [ -z "${TEO_ZONE_ID}" ]; then
              echo "âš ï¸ æœªé…ç½® TEO_ZONE_IDï¼Œè·³è¿‡åˆ·æ–°"
              exit 0
            fi
            
            # 2. å®‰è£…è…¾è®¯äº‘ EdgeOne SDK
            echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
            pip install --no-cache-dir tencentcloud-sdk-python-teo -i https://mirrors.cloud.tencent.com/pypi/simple
            
            # 3. æ‰§è¡Œåˆ·æ–°è„šæœ¬
            echo "ğŸ”„ è°ƒç”¨ API åˆ·æ–°å…¨ç«™ç¼“å­˜..."
            python -c "
            import os
            import sys
            import json
            from tencentcloud.common import credential
            from tencentcloud.common.exception.tencent_cloud_sdk_exception import TencentCloudSDKException
            from tencentcloud.teo.v20220901 import teo_client, models

            try:
                # åˆå§‹åŒ–è®¤è¯
                cred = credential.Credential(
                    os.environ.get('COS_SECRET_ID'), 
                    os.environ.get('COS_SECRET_KEY')
                )
                
                # åˆå§‹åŒ–å®¢æˆ·ç«¯
                client = teo_client.TeoClient(cred, 'ap-guangzhou')
                
                # æ„é€ è¯·æ±‚: åˆ·æ–°å…¨ç«™ (purge_host)
                req = models.CreatePurgeTaskRequest()
                req.ZoneId = os.environ.get('TEO_ZONE_ID')
                req.Type = 'purge_host' 
                req.Targets = [ os.environ.get('CDN_DOMAIN', 'www.l-souljourney.cn') ] 
                
                # å‘é€è¯·æ±‚
                resp = client.CreatePurgeTask(req)
                print(f'âœ… åˆ·æ–°ä»»åŠ¡æäº¤æˆåŠŸ! TaskId: {resp.JobId}')
                
            except TencentCloudSDKException as err:
                print(f'âŒ åˆ·æ–°å¤±è´¥: {err}')
                sys.exit(1)
            except Exception as e:
                print(f'âŒ ç³»ç»Ÿé”™è¯¯: {e}')
                sys.exit(1)
            "

# Pull Requestï¼šå¿«é€Ÿæ£€æŸ¥
pull_request:
  push:
    - env:
        TZ: Asia/Shanghai
      
      docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: pr build check
          script: |
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            pnpm install --frozen-lockfile
            pnpm run build
            echo "âœ… PRæ„å»ºæ£€æŸ¥é€šè¿‡"