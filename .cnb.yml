# CNB æ„å»ºé…ç½®æ–‡ä»¶ - ç®€åŒ–ç‰ˆæœ¬
# ä½¿ç”¨å®˜æ–¹æ¨èçš„ volumes ç¼“å­˜æ–¹æ¡ˆ

# ç¯å¢ƒå˜é‡å¯¼å…¥
env:
  imports:
    - https://cnb.cool/l-souljourney/env/-/blob/main/env.yml

# ä¸»åˆ†æ”¯ï¼šç”Ÿäº§ç¯å¢ƒæ„å»º+éƒ¨ç½²
main:
  push:
    - docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: setup environment
          script: |
            echo "ğŸš€ å¼€å§‹ç¯å¢ƒå‡†å¤‡..."
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            pnpm config set prefer-offline true
            echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
            
        - name: install dependencies
          script: |
            echo "ğŸ“¦ å¼€å§‹å®‰è£…ä¾èµ–..."
            time pnpm install --frozen-lockfile
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            
        - name: build project
          script: |
            echo "ğŸ—ï¸ å¼€å§‹æ„å»ºé¡¹ç›®..."
            time pnpm run build
            echo "âœ… é¡¹ç›®æ„å»ºå®Œæˆ"
            ls -la dist/
            
        - name: deploy to cos
          script: |
            echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘COS..."
            
            # å®‰è£…Pythonå’Œcoscmdå·¥å…·
            apk add --no-cache python3 py3-pip
            pip3 install coscmd
            
            # éªŒè¯ç¯å¢ƒå˜é‡
            echo "éªŒè¯COSé…ç½®ç¯å¢ƒå˜é‡..."
            echo "COS_SECRET_ID: ${COS_SECRET_ID:0:10}***"
            echo "COS_BUCKET: ${COS_BUCKET}"
            echo "COS_REGION: ${COS_REGION}"
            
            # é…ç½®coscmd
            coscmd config -a ${COS_SECRET_ID} -s ${COS_SECRET_KEY} -b ${COS_BUCKET} -r ${COS_REGION}
            
            # æ˜¾ç¤ºå½“å‰æ„å»ºäº§ç‰©
            echo "æ„å»ºäº§ç‰©ç›®å½•å†…å®¹ï¼š"
            ls -la dist/
            du -sh dist/
            
            # ä¸Šä¼ åˆ°COSï¼ˆæ¸…ç†æ—§æ–‡ä»¶å¹¶ä¸Šä¼ æ–°æ–‡ä»¶ï¼‰
            echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°COS..."
            coscmd upload -r dist/ / --delete --ignore ".git/*,*.log"
            
            echo "âœ… COSéƒ¨ç½²å®Œæˆ"
            echo "ğŸŒ ç½‘ç«™å·²æ›´æ–°åˆ°ç”Ÿäº§ç¯å¢ƒ"

# å¼€å‘åˆ†æ”¯ï¼šä»…æ„å»ºæµ‹è¯•
develop:
  push:
    - docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: setup environment
          script: |
            echo "ğŸš€ å¼€å§‹ç¯å¢ƒå‡†å¤‡..."
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            pnpm config set prefer-offline true
            echo "âœ… ç¯å¢ƒå‡†å¤‡å®Œæˆ"
            
        - name: install dependencies
          script: |
            echo "ğŸ“¦ å¼€å§‹å®‰è£…ä¾èµ–..."
            time pnpm install --frozen-lockfile
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            
        - name: build test
          script: |
            echo "ğŸ—ï¸ å¼€å§‹æ„å»ºæµ‹è¯•..."
            time pnpm run build
            echo "âœ… æ„å»ºæµ‹è¯•å®Œæˆ"
            ls -la dist/

# Pull Requestï¼šå¿«é€Ÿæ„å»ºæ£€æŸ¥
pull_request:
  - docker:
      image: node:18-alpine
      volumes:
        - node_modules:copy-on-write
        - /root/.local/share/pnpm:copy-on-write
    stages:
      - name: quick check
        script: |
          echo "âš¡ å¼€å§‹å¿«é€Ÿæ£€æŸ¥..."
          npm install -g pnpm@latest
          pnpm install --frozen-lockfile
          pnpm run build
          echo "âœ… å¿«é€Ÿæ£€æŸ¥å®Œæˆ" 