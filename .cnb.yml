version: '1.0'
name: "Astroåšå®¢åŒçº¿éƒ¨ç½²"
description: "æ„å»ºéƒ¨ç½²åˆ°è…¾è®¯äº‘COSï¼ŒåŒæ­¥åˆ°GitHubè§¦å‘Cloudflare Pages"

# æ„å»ºç¯å¢ƒé…ç½®
build:
  environment:
    image: "node:18"
    
  env:
    - NODE_ENV=production
    - ASTRO_TELEMETRY_DISABLED=1
    
  cache:
    paths:
      - "node_modules"
      - ".pnpm-store"
      
  steps:
    - name: "ğŸ”§ ç¯å¢ƒå‡†å¤‡"
      script: |
        echo "=== ç¯å¢ƒä¿¡æ¯ ==="
        node --version
        npm --version
        echo "å¼€å§‹å®‰è£…pnpm..."
        npm install -g pnpm
        pnpm --version
        echo "ç¯å¢ƒå‡†å¤‡å®Œæˆ âœ…"
        
    - name: "ğŸ“¦ å®‰è£…ä¾èµ–"
      script: |
        echo "=== å®‰è£…é¡¹ç›®ä¾èµ– ==="
        pnpm config set registry https://registry.npmmirror.com
        pnpm install --frozen-lockfile --store-dir .pnpm-store
        echo "ä¾èµ–å®‰è£…å®Œæˆ âœ…"
        
    - name: "ğŸ—ï¸ æ„å»ºé¡¹ç›®"
      script: |
        echo "=== å¼€å§‹æ„å»ºAstroé¡¹ç›® ==="
        pnpm build
        echo "=== æ„å»ºäº§ç‰©æ£€æŸ¥ ==="
        ls -la dist/
        echo "æ–‡ä»¶æ€»æ•°: $(find dist -type f | wc -l)"
        echo "æ„å»ºç›®å½•å¤§å°: $(du -sh dist/)"
        echo "é¡¹ç›®æ„å»ºå®Œæˆ âœ…"
        
    - name: "ğŸš€ éƒ¨ç½²åˆ°è…¾è®¯äº‘COS"
      script: |
        echo "=== å¼€å§‹éƒ¨ç½²åˆ°è…¾è®¯äº‘COS ==="
        echo "COSéƒ¨ç½²å®Œæˆ âœ…"
        
    - name: "ğŸ“¤ åŒæ­¥åˆ°GitHub"
      script: |
        echo "=== åŒæ­¥åˆ°GitHubä»“åº“ ==="
        git config user.name "CNB Auto Deploy"
        git config user.email "deploy@cnb.cool"
        git push https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git HEAD:main --force
        echo "GitHubåŒæ­¥å®Œæˆ âœ…"

# éƒ¨ç½²é…ç½®
deploy:
  cos:
    bucket: "${COS_BUCKET}"
    region: "ap-guangzhou"
    local_path: "./dist"
    remote_path: "/"
    clean: true
    
  cdn:
    domains:
      - "blog.l-souljourney.cn"
    paths:
      - "/*"

# è§¦å‘æ¡ä»¶
triggers:
  - type: "push"
    branches:
      - "main"
  - type: "manual"

# é€šçŸ¥é…ç½®
notifications:
  success:
    message: |
      ğŸ‰ åšå®¢éƒ¨ç½²æˆåŠŸï¼
      ğŸŒ å›½å†…è®¿é—®: https://blog.l-souljourney.cn
      ğŸŒ æµ·å¤–è®¿é—®: Cloudflare Pages (è‡ªåŠ¨æ„å»ºä¸­)
      
  failure:
    message: |
      âŒ åšå®¢éƒ¨ç½²å¤±è´¥
      ğŸ” è¯·æ£€æŸ¥æ„å»ºæ—¥å¿—
