# è…¾è®¯äº‘ CNB (Cloud Native Builder) æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢ç®€åŒ–éƒ¨ç½²é…ç½®

# ä¸»åˆ†æ”¯ - ç”Ÿäº§éƒ¨ç½²
main:
  push:
    - name: astro-blog-deploy
      image: node:18
      env:
        NODE_ENV: production
        ASTRO_TELEMETRY_DISABLED: "1"
        TZ: Asia/Shanghai
      
      script: |
        echo "ğŸš€ å¼€å§‹æ„å»º L-Souljourney åšå®¢..."
        
        # ç¯å¢ƒä¿¡æ¯
        echo "ğŸ“‹ ç¯å¢ƒä¿¡æ¯:"
        node --version
        npm --version
        
        # å®‰è£… pnpm
        echo "ğŸ“¦ å®‰è£… pnpm åŒ…ç®¡ç†å™¨..."
        npm install -g pnpm@latest
        pnpm --version
        
        # å®‰è£…ä¾èµ–
        echo "ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–..."
        pnpm install --frozen-lockfile
        
        # æ„å»ºé¡¹ç›®
        echo "ğŸ”¨ æ„å»º Astro é¡¹ç›®..."
        pnpm build
        
        # æ˜¾ç¤ºæ„å»ºç»“æœ
        echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
        ls -la dist/
        du -sh dist/
        find dist -type f | wc -l | xargs echo "æ–‡ä»¶æ•°é‡:"
        
        echo "âœ… æ„å»ºå®Œæˆ"
      
      # éƒ¨ç½²é˜¶æ®µ
      stages:
        # éƒ¨ç½²åˆ°è…¾è®¯äº‘ COS
        - name: deploy-to-cos
          image: cnbcool/tencent-cos
          settings:
            bucket: souljourney-1251969283
            region: ap-shanghai
            source: ./dist/
            target: /
            delete_extra: true
            exclude:
              - "*.map"
              - "*.log"
              - ".DS_Store"
            headers:
              "*.html":
                content-type: "text/html; charset=utf-8"
                cache-control: "public, max-age=3600"
              "*.css":
                content-type: "text/css; charset=utf-8"
                cache-control: "public, max-age=31536000"
              "*.js":
                content-type: "application/javascript; charset=utf-8"
                cache-control: "public, max-age=31536000"
              "*.{jpg,jpeg,png,gif,webp,svg,ico}":
                cache-control: "public, max-age=31536000"
              "*.{woff,woff2,ttf,eot}":
                cache-control: "public, max-age=31536000"
                
        # åˆ·æ–° CDN
        - name: refresh-cdn
          image: cnbcool/tencent-cdn
          settings:
            paths:
              - "/*"
            type: flush
            
        # éƒ¨ç½²æˆåŠŸé€šçŸ¥
        - name: notify-success
          image: alpine
          script: |
            echo "ğŸ‰ åšå®¢éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸŒ è®¿é—®åœ°å€: https://blog.l-souljourney.cn"
            echo "ğŸ“Š éƒ¨ç½²ä¿¡æ¯:"
            echo "   - æ„å»ºæ—¶é—´: $(date)"
            echo "   - Git æäº¤: $CNB_GIT_COMMIT_SHA"
            echo "   - åˆ†æ”¯: $CNB_GIT_REF"
      
      # ç¼“å­˜é…ç½®
      cache:
        paths:
          - node_modules
          - .pnpm-store
        key: pnpm-{{ checksum "pnpm-lock.yaml" }}

# å¼€å‘åˆ†æ”¯ - ä»…æ„å»ºæµ‹è¯•
develop:
  push:
    - name: astro-blog-test
      image: node:18
      env:
        NODE_ENV: development
        ASTRO_TELEMETRY_DISABLED: "1"
      
      script: |
        echo "ğŸ§ª å¼€å§‹æµ‹è¯•æ„å»º..."
        
        # å®‰è£… pnpm å’Œä¾èµ–
        npm install -g pnpm@latest
        pnpm install --frozen-lockfile
        
        # æ„å»ºæµ‹è¯•
        pnpm build
        
        echo "âœ… æµ‹è¯•æ„å»ºå®Œæˆ"
        ls -la dist/
      
      cache:
        paths:
          - node_modules
          - .pnpm-store
        key: pnpm-test-{{ checksum "pnpm-lock.yaml" }}

# PR æ„å»ºæ£€æŸ¥
"**":
  pull_request:
    - name: pr-check
      image: node:18
      env:
        NODE_ENV: development
        ASTRO_TELEMETRY_DISABLED: "1"
      
      script: |
        echo "ğŸ” PR æ„å»ºæ£€æŸ¥..."
        npm install -g pnpm@latest
        pnpm install --frozen-lockfile
        pnpm build
        echo "âœ… PR æ£€æŸ¥é€šè¿‡"
      
      cache:
        paths:
          - node_modules
          - .pnpm-store
        key: pnpm-pr-{{ checksum "pnpm-lock.yaml" }} 