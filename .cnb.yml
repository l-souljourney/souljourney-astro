# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢é¡¹ç›®

main:
  push:
    - docker:
        image: node:18-alpine
      stages:
        - echo "ğŸ”§ === ç¯å¢ƒå‡†å¤‡ ==="
        - node --version
        - npm --version
        - echo "å®‰è£…pnpm..."
        - npm install -g pnpm
        - pnpm --version
        - echo "ç¯å¢ƒå‡†å¤‡å®Œæˆ âœ…"
        - echo "ğŸ“¦ === å®‰è£…é¡¹ç›®ä¾èµ– ==="
        - pnpm config set registry https://registry.npmmirror.com
        - pnpm install --frozen-lockfile
        - echo "ä¾èµ–å®‰è£…å®Œæˆ âœ…"
        - echo "ğŸ—ï¸ === æ„å»ºAstroé¡¹ç›® ==="
        - pnpm build
        - echo "=== æ„å»ºäº§ç‰©æ£€æŸ¥ ==="
        - ls -la dist/
        - echo "æ–‡ä»¶æ€»æ•°ï¼š$(find dist -type f | wc -l)"
        - echo "æ„å»ºå®Œæˆ âœ…"
      plugins:
        - name: cnbcool/tencent-cos
          with:
            secret_id: ${COS_SECRET_ID}
            secret_key: ${COS_SECRET_KEY}
            bucket: ${COS_BUCKET}
            region: ${COS_REGION}
            src: dist/
            dest: /
            delete: true
        - name: cnbcool/tencent-cdn
          if: ${CDN_DOMAIN}
          with:
            domain: ${CDN_DOMAIN}
            secret_id: ${COS_SECRET_ID}
            secret_key: ${COS_SECRET_KEY}
            type: directory
            path: /

develop:
  push:
    - docker:
        image: node:18-alpine
      stages:
        - echo "ğŸ”§ === å¼€å‘ç¯å¢ƒæ„å»ºæµ‹è¯• ==="
        - node --version
        - npm install -g pnpm
        - pnpm config set registry https://registry.npmmirror.com
        - pnpm install --frozen-lockfile
        - pnpm build
        - echo "å¼€å‘æ„å»ºæµ‹è¯•å®Œæˆ âœ…"

"**":
  pull_request:
    - docker:
        image: node:18-alpine
      stages:
        - echo "ğŸ” === PRæ„å»ºæ£€æŸ¥ ==="
        - node --version
        - npm install -g pnpm
        - pnpm config set registry https://registry.npmmirror.com
        - pnpm install --frozen-lockfile
        - pnpm build
        - echo "PRæ„å»ºæ£€æŸ¥å®Œæˆ âœ…"

"$":
  push:
    name: é»˜è®¤åˆ†æ”¯æ„å»º
    env:
      TZ: Asia/Shanghai
    image: node:18-alpine
    script: |
      echo "ğŸ”§ === åŸºç¡€æ„å»ºæµ‹è¯• ==="
      node --version
      npm install -g pnpm
      pnpm config set registry https://registry.npmmirror.com
      pnpm install --frozen-lockfile
      pnpm build
      echo "åŸºç¡€æ„å»ºå®Œæˆ âœ…"
