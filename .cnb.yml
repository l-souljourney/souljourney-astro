# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢é¡¹ç›®

# é€šç”¨é…ç½®é”šç‚¹
.common_config: &common_config
  imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
  docker:
    image: node:18-alpine
    # é…ç½®CNBæ•°æ®å·ç¼“å­˜ - ä½¿ç”¨CNBå®˜æ–¹å»ºè®®çš„æ˜ç¡®è·¯å¾„å‘½åï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    volumes:
      - /workspace/.cnb_cache/node_modules:/workspace/node_modules
      - /workspace/.cnb_cache/pnpm-store:/root/.local/share/pnpm/store
      - /workspace/.cnb_cache/pnpm-cache:/root/.cache/pnpm

# é€šç”¨æ„å»ºæ­¥éª¤
.build_steps: &build_steps
  - echo "ğŸ”§ === ç¯å¢ƒå‡†å¤‡ ==="
  - node --version
  - echo "ğŸ“¦ === é…ç½®pnpm ==="
  - npm install -g pnpm@latest
  - pnpm --version
  # é…ç½®pnpmé•œåƒæºå’Œç¼“å­˜
  - pnpm config set registry https://mirrors.cloud.tencent.com/npm/
  - pnpm config set store-dir /root/.local/share/pnpm/store
  - pnpm config set cache-dir /root/.cache/pnpm
  - pnpm config set state-dir /root/.local/state/pnpm
  - pnpm config set prefer-offline true
  # ä¼˜åŒ–ç½‘ç»œé…ç½®
  - pnpm config set network-timeout 120000
  - pnpm config set fetch-retries 3
  - pnpm config set network-concurrency 16
  - echo "ğŸ” === ç¼“å­˜çŠ¶æ€æ£€æŸ¥ ==="
  - echo "æ£€æŸ¥node_modulesç¼“å­˜ï¼š"
  - ls -la /workspace/node_modules 2>/dev/null | head -3 || echo "âŒ node_modulesç¼“å­˜ä¸å­˜åœ¨"
  - echo "æ£€æŸ¥pnpm storeç¼“å­˜ï¼š"
  - ls -la /root/.local/share/pnpm/store 2>/dev/null | head -3 || echo "âŒ pnpm storeç¼“å­˜ä¸å­˜åœ¨"
  - echo "æ£€æŸ¥pnpm cacheç¼“å­˜ï¼š"
  - ls -la /root/.cache/pnpm 2>/dev/null | head -3 || echo "âŒ pnpm cacheç¼“å­˜ä¸å­˜åœ¨"
  - echo "ğŸ“¦ === å®‰è£…ä¾èµ– ==="
  - echo "å¼€å§‹æ—¶é—´ï¼š$(date '+%H:%M:%S')"
  - pnpm install --frozen-lockfile --prefer-offline
  - echo "å®Œæˆæ—¶é—´ï¼š$(date '+%H:%M:%S')"
  - echo "ğŸ—ï¸ === æ„å»ºé¡¹ç›® ==="
  - pnpm build

main:
  push:
    - <<: *common_config
      stages:
        - *build_steps
        - echo "âœ… === æ„å»ºå®Œæˆ ==="
        - echo "ğŸ“ === æ„å»ºäº§ç‰©æ£€æŸ¥ ==="
        - ls -la dist/ | head -10
        - echo "æ–‡ä»¶æ€»æ•°ï¼š$(find dist -type f | wc -l)"
        - echo "æ€»å¤§å°ï¼š$(du -sh dist/)"
        - echo "ğŸš€ === å¼€å§‹éƒ¨ç½²åˆ°COS ==="
      plugins:
        - name: cnbcool/tencent-cos
          with:
            secret_id: ${COS_SECRET_ID}
            secret_key: ${COS_SECRET_KEY}
            bucket: ${COS_BUCKET}
            region: ${COS_REGION}
            src: dist/
            dest: /
            delete: true
        - name: cos-deploy-check
          stages:
            - echo "âœ… === COSéƒ¨ç½²å®Œæˆç¡®è®¤ ==="
            - echo "ğŸŒ å­˜å‚¨æ¡¶: ${COS_BUCKET}"
            - echo "ğŸ“ åŒºåŸŸ: ${COS_REGION}"
            - echo "ğŸ“‚ ç›®æ ‡è·¯å¾„: /"
            - echo "ğŸ—‘ï¸ åˆ é™¤æ—§æ–‡ä»¶: æ˜¯"
            - echo "ğŸ‰ COSéƒ¨ç½²æˆåŠŸï¼"
        - name: cnbcool/tencent-cdn
          if: ${CDN_DOMAIN}
          with:
            domain: ${CDN_DOMAIN}
            secret_id: ${COS_SECRET_ID}
            secret_key: ${COS_SECRET_KEY}
            type: directory
            path: /
        - name: cdn-refresh-check
          if: ${CDN_DOMAIN}
          stages:
            - echo "âœ… === CDNåˆ·æ–°å®Œæˆç¡®è®¤ ==="
            - echo "ğŸŒ åŸŸå: ${CDN_DOMAIN}"
            - echo "ğŸ“‚ åˆ·æ–°è·¯å¾„: /"
            - echo "ğŸ”„ CDNç¼“å­˜åˆ·æ–°æˆåŠŸï¼"
        - name: github-sync
          if: ${GITHUB_TOKEN}
          stages:
            - echo "ğŸ“¤ === åŒæ­¥åˆ°GitHub ==="
            - apk add --no-cache git
            - git config --global user.name "CNB Deploy Bot"
            - git config --global user.email "noreply@cnb.cool"
            - git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git || git remote set-url github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git
            - git push github main --force
            - echo "âœ… GitHubåŒæ­¥å®Œæˆ"

develop:
  push:
    - <<: *common_config
      stages:
        - *build_steps
        - echo "âœ… === å¼€å‘æµ‹è¯•å®Œæˆ ==="

"**":
  pull_request:
    - <<: *common_config
      stages:
        - *build_steps
        - echo "âœ… === PRæ£€æŸ¥å®Œæˆ ==="


