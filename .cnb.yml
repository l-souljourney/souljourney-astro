# CNB æ„å»ºé…ç½®æ–‡ä»¶ - ä¼˜åŒ–ç”Ÿäº§ç‰ˆæœ¬
# SoulJourneyBlog Astro æ„å»ºéƒ¨ç½²

# ä¸»åˆ†æ”¯ï¼šç”Ÿäº§ç¯å¢ƒæ„å»º+éƒ¨ç½²
main:
  push:
    - # ä»å¯†é’¥ä»“åº“å¯¼å…¥ç¯å¢ƒå˜é‡
      imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      env:
        TZ: Asia/Shanghai
      
      docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: build project
          script: |
            echo "ğŸš€ å¼€å§‹æ„å»ºæµç¨‹..."
            
            # ç¯å¢ƒå‡†å¤‡
            echo "ğŸ“¦ å®‰è£…pnpmå¹¶é…ç½®é•œåƒæº..."
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¥ å®‰è£…é¡¹ç›®ä¾èµ–..."
            pnpm install --frozen-lockfile
            
            # æ„å»ºé¡¹ç›®
            echo "ğŸ—ï¸ æ„å»ºAstroé¡¹ç›®..."
            pnpm run build
            
            # éªŒè¯æ„å»ºäº§ç‰©
            echo "âœ… æ„å»ºå®Œæˆï¼Œäº§ç‰©ä¿¡æ¯:"
            du -sh dist/
            echo "æ–‡ä»¶æ•°é‡: $(find dist/ -type f | wc -l)"
            
        - name: deploy to github
          image: alpine/git:latest
          script: |
            echo "ğŸ“¤ æ¨é€åˆ°GitHub..."
            
            # æ£€æŸ¥GitHub Token
            if [ -z "${GITHUB_TOKEN}" ]; then
              echo "âš ï¸  GITHUB_TOKENæœªè®¾ç½®ï¼Œè·³è¿‡GitHubæ¨é€"
              exit 0
            fi
            
            echo "âœ… GitHub Tokenå·²è®¾ç½®"
            
            # é…ç½®Git
            git config --global user.name "CNB Auto Deploy"
            git config --global user.email "cnb@l-souljourney.cn"
            git config --global init.defaultBranch main
            
            # æ¨é€åˆ°GitHub
            git remote set-url origin "https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git"
            git push origin HEAD:main
            
            echo "âœ… GitHubæ¨é€å®Œæˆ"
            
        - name: deploy to cos
          image: tencentcom/coscli:latest
          script: |
            echo "â˜ï¸ éƒ¨ç½²åˆ°è…¾è®¯äº‘COS..."
            
            # æ£€æŸ¥ç¯å¢ƒå˜é‡
            if [ -z "${COS_SECRET_ID}" ] || [ -z "${COS_SECRET_KEY}" ] || [ -z "${COS_BUCKET}" ] || [ -z "${COS_REGION}" ]; then
              echo "âŒ COSç¯å¢ƒå˜é‡ä¸å®Œæ•´ï¼š"
              echo "COS_SECRET_ID: ${COS_SECRET_ID:+å·²è®¾ç½®}"
              echo "COS_SECRET_KEY: ${COS_SECRET_KEY:+å·²è®¾ç½®}"  
              echo "COS_BUCKET: '${COS_BUCKET}'"
              echo "COS_REGION: '${COS_REGION}'"
              exit 1
            fi
            
            echo "âœ… COSç¯å¢ƒå˜é‡æ£€æŸ¥é€šè¿‡"
            
            # é…ç½®coscli
            echo "ğŸ”§ é…ç½®COS CLI..."
            coscli config set --secret_id "${COS_SECRET_ID}" --secret_key "${COS_SECRET_KEY}"
            coscli config add --init-skip=true -b "${COS_BUCKET}" -r "${COS_REGION}"
            
            # éªŒè¯æ„å»ºäº§ç‰©
            if [ ! -d "dist" ]; then
              echo "âŒ æ‰¾ä¸åˆ°æ„å»ºäº§ç‰©ç›®å½• dist/"
              exit 1
            fi
            
            echo "ğŸ“ æ„å»ºäº§ç‰©æ£€æŸ¥:"
            ls -la dist/ | head -10
            echo "äº§ç‰©å¤§å°: $(du -sh dist/ | cut -f1)"
            
            # åŒæ­¥åˆ°COS
            echo "ğŸ“¤ åŒæ­¥æ–‡ä»¶åˆ°COS..."
            echo "æºç›®å½•: dist/"
            echo "ç›®æ ‡: cos://${COS_BUCKET}/"
            
            coscli sync dist/ "cos://${COS_BUCKET}/" --delete --disable-crc64
            
            echo "âœ… COSéƒ¨ç½²å®Œæˆï¼"
            
            # æ˜¾ç¤ºè®¿é—®ä¿¡æ¯
            if [ -n "${CDN_DOMAIN}" ]; then
              echo "ğŸŒ è®¿é—®åœ°å€: https://${CDN_DOMAIN}"
            else
              echo "ğŸŒ COSåŸŸå: ${COS_BUCKET}.cos.${COS_REGION}.myqcloud.com"
            fi

# å¼€å‘åˆ†æ”¯ï¼šæ„å»ºæµ‹è¯•
develop:
  push:
    - imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      env:
        TZ: Asia/Shanghai
      
      docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: build test
          script: |
            echo "ğŸ§ª å¼€å‘ç¯å¢ƒæ„å»ºæµ‹è¯•..."
            
            # ç¯å¢ƒå‡†å¤‡
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            
            # å®‰è£…ä¾èµ–
            echo "ğŸ“¥ å®‰è£…ä¾èµ–..."
            pnpm install --frozen-lockfile
            
            # æ„å»ºæµ‹è¯•
            echo "ğŸ—ï¸ æ„å»ºæµ‹è¯•..."
            pnpm run build
            
            echo "âœ… å¼€å‘ç¯å¢ƒæ„å»ºæµ‹è¯•é€šè¿‡"
            echo "ğŸ“Š æ„å»ºäº§ç‰©: $(du -sh dist/ | cut -f1)"

# Pull Requestï¼šå¿«é€Ÿæ£€æŸ¥
pull_request:
  push:
    - env:
        TZ: Asia/Shanghai
      
      docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: pr build check
          script: |
            echo "ğŸ” PRæ„å»ºæ£€æŸ¥..."
            
            # å¿«é€Ÿæ„å»ºéªŒè¯
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            pnpm install --frozen-lockfile
            pnpm run build
            
            echo "âœ… PRæ„å»ºæ£€æŸ¥é€šè¿‡" 