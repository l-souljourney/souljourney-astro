# CNB 构建配置文件 - 使用官方COS插件
# 采用CNB官方腾讯云COSCMD插件

# 环境变量导入 - 使用CNB标准格式
env:
  imports:
    - l-souljourney/env@main:env.yml

# 主分支：生产环境构建+部署
main:
  push:
    - docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: setup environment
          script: |
            echo "🚀 开始环境准备..."
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            echo "✅ 环境准备完成"
            
        - name: install dependencies
          script: |
            echo "📦 开始安装依赖..."
            time pnpm install --frozen-lockfile
            echo "✅ 依赖安装完成"
            
        - name: build project
          script: |
            echo "🏗️ 开始构建项目..."
            time pnpm run build
            echo "📊 构建产物大小:"
            du -sh dist/
            ls -la dist/
            echo "✅ 项目构建完成"
            
        - name: deploy to cos
          # 使用官方腾讯云coscli插件 - 参考demo正确语法
          image: tencentcom/coscli
          # 确保环境变量在此阶段可用
          env:
            imports:
              - l-souljourney/env@main:env.yml
          script: |
            echo "🚀 开始部署到腾讯云COS..."
            
            # 详细验证环境变量
            echo "=== 环境变量检查 ==="
            echo "COS_SECRET_ID: ${COS_SECRET_ID:0:10}***"
            echo "COS_SECRET_KEY: ${COS_SECRET_KEY:0:5}***"
            echo "COS_BUCKET: '${COS_BUCKET}'"
            echo "COS_REGION: '${COS_REGION}'"
            
            # 检查必要环境变量
            if [ -z "$COS_SECRET_ID" ] || [ -z "$COS_SECRET_KEY" ] || [ -z "$COS_BUCKET" ] || [ -z "$COS_REGION" ]; then
              echo "❌ 环境变量缺失！请检查CNB密钥仓库配置"
              echo "需要配置: COS_SECRET_ID, COS_SECRET_KEY, COS_BUCKET, COS_REGION"
              exit 1
            fi
            
            # 配置coscli认证
            echo "=== 配置COS认证 ==="
            coscli config set --secret_id "$COS_SECRET_ID" --secret_key "$COS_SECRET_KEY" 
            coscli config add --init-skip=true -b "$COS_BUCKET" -r "$COS_REGION"
            
            # 验证配置
            echo "=== 验证COS配置 ==="
            coscli config show
            
            # 显示构建产物
            echo "=== 构建产物信息 ==="
            echo "构建产物目录内容："
            ls -la dist/
            echo "构建产物大小："
            du -sh dist/
            
            # 上传到COS
            echo "=== 开始上传到COS ==="
            coscli cp dist/ cos://$COS_BUCKET/ -r --exclude "./.git/*"
            
            # 验证上传结果
            echo "=== 验证上传结果 ==="
            coscli ls cos://$COS_BUCKET/ | head -10
            
            echo "✅ COS部署完成"
            echo "🌐 网站已更新到生产环境"

# 开发分支：仅构建测试
develop:
  push:
    - docker:
        image: node:18-alpine
        volumes:
          - node_modules:copy-on-write
          - /root/.local/share/pnpm:copy-on-write
          - /root/.cache/pnpm:copy-on-write
      stages:
        - name: setup environment
          script: |
            echo "🚀 开始环境准备..."
            npm install -g pnpm@latest
            pnpm config set registry https://mirrors.cloud.tencent.com/npm/
            echo "✅ 环境准备完成"
            
        - name: install dependencies
          script: |
            echo "📦 开始安装依赖..."
            time pnpm install --frozen-lockfile
            echo "✅ 依赖安装完成"
            
        - name: build test
          script: |
            echo "🏗️ 开始构建测试..."
            time pnpm run build
            echo "📊 构建产物大小:"
            du -sh dist/
            ls -la dist/ | head -10
            echo "✅ 构建测试完成"

# Pull Request：快速构建检查
pull_request:
  - docker:
      image: node:18-alpine
      volumes:
        - node_modules:copy-on-write
        - /root/.local/share/pnpm:copy-on-write
        - /root/.cache/pnpm:copy-on-write
    stages:
      - name: quick check
        script: |
          echo "⚡ 开始快速检查..."
          npm install -g pnpm@latest
          pnpm config set registry https://mirrors.cloud.tencent.com/npm/
          time pnpm install --frozen-lockfile
          time pnpm run build
          echo "✅ 快速检查完成" 