# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢é¡¹ç›®

main:
  push:
    - # å¯¼å…¥å¯†é’¥ä»“åº“ä¸­çš„ç¯å¢ƒå˜é‡æ–‡ä»¶
      imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      docker:
        image: node:18-alpine
      # é…ç½®æ•°æ®å·ç¼“å­˜
      volumes:
        - /cnb/cache/node_modules:/workspace/node_modules
        - /cnb/cache/pnpm-store:/root/.local/share/pnpm/store
        - /cnb/cache/pnpm-cache:/cnb/cache/pnpm-cache
        - /cnb/cache/npm-cache:/root/.npm
      stages:
        - echo "ğŸ”§ === ç¯å¢ƒå‡†å¤‡ ==="
        - node --version
        - npm --version
        - echo "ğŸ“¦ === pnpmç¯å¢ƒé…ç½® ==="
        - npm install -g pnpm@latest
        - pnpm --version
        # ä¼˜åŒ–pnpmç½‘ç»œé…ç½®å’Œç¼“å­˜é…ç½®
        - pnpm config set registry https://mirrors.cloud.tencent.com/npm/
        - pnpm config set store-dir /root/.local/share/pnpm/store
        - pnpm config set cache-dir /cnb/cache/pnpm-cache
        - pnpm config set network-timeout 300000
        - pnpm config set fetch-retries 5
        - pnpm config set fetch-retry-mintimeout 20000
        - pnpm config set fetch-retry-maxtimeout 120000
        - pnpm config set network-concurrency 3
        - pnpm config set prefer-offline true
        - echo "ğŸ“¦ === æ£€æŸ¥ç¼“å­˜çŠ¶æ€ ==="
        - ls -la /cnb/cache/ || mkdir -p /cnb/cache/
        - ls -la /root/.local/share/pnpm/store || echo "Storeç›®å½•ä¸å­˜åœ¨ï¼Œå°†è‡ªåŠ¨åˆ›å»º"
        - echo "ğŸ“¦ === å®‰è£…é¡¹ç›®ä¾èµ– ==="
        - pnpm install --frozen-lockfile --prefer-offline --reporter=append-only
        - echo "ğŸ—ï¸ === æ„å»ºAstroé¡¹ç›® ==="
        - pnpm build
        - echo "=== æ„å»ºäº§ç‰©æ£€æŸ¥ ==="
        - ls -la dist/
        - echo "æ–‡ä»¶æ€»æ•°ï¼š$(find dist -type f | wc -l)"
        - echo "æ„å»ºå®Œæˆ âœ…"
      plugins:
        - name: cnbcool/tencent-cos
          with:
            secret_id: ${COS_SECRET_ID}
            secret_key: ${COS_SECRET_KEY}
            bucket: ${COS_BUCKET}
            region: ${COS_REGION}
            src: dist/
            dest: /
            delete: true
        - name: cnbcool/tencent-cdn
          if: ${CDN_DOMAIN}
          with:
            domain: ${CDN_DOMAIN}
            secret_id: ${COS_SECRET_ID}
            secret_key: ${COS_SECRET_KEY}
            type: directory
            path: /
        - name: github-sync
          if: ${GITHUB_TOKEN}
          stages:
            - echo "ğŸ“¤ === åŒæ­¥åˆ°GitHub ==="
            - apk add --no-cache git
            - git config --global user.name "CNB Deploy Bot"
            - git config --global user.email "noreply@cnb.cool"
            - git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git || git remote set-url github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git
            - git push github main --force
            - echo "GitHubåŒæ­¥å®Œæˆ âœ…"

develop:
  push:
    - imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      docker:
        image: node:18-alpine
      # é…ç½®æ•°æ®å·ç¼“å­˜
      volumes:
        - /cnb/cache/node_modules:/workspace/node_modules
        - /cnb/cache/pnpm-store:/root/.local/share/pnpm/store
        - /cnb/cache/pnpm-cache:/cnb/cache/pnpm-cache
        - /cnb/cache/npm-cache:/root/.npm
      stages:
        - echo "ğŸ”§ === å¼€å‘ç¯å¢ƒæ„å»ºæµ‹è¯• ==="
        - node --version
        - echo "ğŸ“¦ === pnpmç¯å¢ƒé…ç½® ==="
        - npm install -g pnpm@latest
        - pnpm --version
        # ä¼˜åŒ–pnpmé…ç½®å’Œç¼“å­˜é…ç½®
        - pnpm config set registry https://mirrors.cloud.tencent.com/npm/
        - pnpm config set store-dir /root/.local/share/pnpm/store
        - pnpm config set cache-dir /cnb/cache/pnpm-cache
        - pnpm config set network-timeout 300000
        - pnpm config set fetch-retries 5
        - pnpm config set fetch-retry-mintimeout 20000
        - pnpm config set fetch-retry-maxtimeout 120000
        - pnpm config set network-concurrency 3
        - pnpm config set prefer-offline true
        - echo "ğŸ“¦ === æ£€æŸ¥ç¼“å­˜çŠ¶æ€ ==="
        - ls -la /cnb/cache/ || mkdir -p /cnb/cache/
        - ls -la /root/.local/share/pnpm/store || echo "Storeç›®å½•ä¸å­˜åœ¨ï¼Œå°†è‡ªåŠ¨åˆ›å»º"
        - echo "ğŸ“¦ === å®‰è£…é¡¹ç›®ä¾èµ– ==="
        - pnpm install --frozen-lockfile --prefer-offline --reporter=append-only
        - echo "ğŸ—ï¸ === æ„å»ºæµ‹è¯• ==="
        - pnpm build
        - echo "å¼€å‘æ„å»ºæµ‹è¯•å®Œæˆ âœ…"

"**":
  pull_request:
    - imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml
      docker:
        image: node:18-alpine
      # é…ç½®æ•°æ®å·ç¼“å­˜
      volumes:
        - /cnb/cache/node_modules:/workspace/node_modules
        - /cnb/cache/pnpm-store:/root/.local/share/pnpm/store
        - /cnb/cache/pnpm-cache:/cnb/cache/pnpm-cache
        - /cnb/cache/npm-cache:/root/.npm
      stages:
        - echo "ğŸ” === PRæ„å»ºæ£€æŸ¥ ==="
        - node --version
        - echo "ğŸ“¦ === pnpmç¯å¢ƒé…ç½® ==="
        - npm install -g pnpm@latest
        - pnpm --version
        # ä¼˜åŒ–pnpmé…ç½®å’Œç¼“å­˜é…ç½®
        - pnpm config set registry https://mirrors.cloud.tencent.com/npm/
        - pnpm config set store-dir /root/.local/share/pnpm/store
        - pnpm config set cache-dir /cnb/cache/pnpm-cache
        - pnpm config set network-timeout 300000
        - pnpm config set fetch-retries 5
        - pnpm config set fetch-retry-mintimeout 20000
        - pnpm config set fetch-retry-maxtimeout 120000
        - pnpm config set network-concurrency 3
        - pnpm config set prefer-offline true
        - echo "ğŸ“¦ === æ£€æŸ¥ç¼“å­˜çŠ¶æ€ ==="
        - ls -la /cnb/cache/ || mkdir -p /cnb/cache/
        - ls -la /root/.local/share/pnpm/store || echo "Storeç›®å½•ä¸å­˜åœ¨ï¼Œå°†è‡ªåŠ¨åˆ›å»º"
        - echo "ğŸ“¦ === å®‰è£…é¡¹ç›®ä¾èµ– ==="
        - pnpm install --frozen-lockfile --prefer-offline --reporter=append-only
        - echo "ğŸ—ï¸ === æ„å»ºæ£€æŸ¥ ==="
        - pnpm build
        - echo "PRæ„å»ºæ£€æŸ¥å®Œæˆ âœ…"


