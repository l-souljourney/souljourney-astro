# è…¾è®¯äº‘ CNB æ„å»ºé…ç½®æ–‡ä»¶
# é‡‡ç”¨Dockerç¼“å­˜æ–¹æ¡ˆ - å®˜æ–¹æ¨èçš„ç®€åŒ–é…ç½®

# å…¨å±€é…ç½®
imports: https://cnb.cool/l-souljourney/env/-/blob/main/env.yml

# ===== åˆ†æ”¯é…ç½® =====

# ä¸»åˆ†æ”¯ï¼šç”Ÿäº§ç¯å¢ƒæ„å»º+éƒ¨ç½²
main:
  push:
    - docker:
        # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºå¸¦ç¼“å­˜çš„é•œåƒ
        - name: build-cache
          type: cache
          image: node:18-alpine
          dockerfile: cache.dockerfile
          by:
            - package.json
            - pnpm-lock.yaml
        
        # ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ„å»ºé¡¹ç›®
        - name: build-project
          image: "*build-cache"
          commands:
            - /usr/local/bin/setup-cache.sh
            - /usr/local/bin/build-astro.sh

# å¼€å‘åˆ†æ”¯ï¼šä»…æ„å»ºæµ‹è¯•
develop:
  push:
    - docker:
        # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºå¸¦ç¼“å­˜çš„é•œåƒ
        - name: build-cache
          type: cache
          image: node:18-alpine
          dockerfile: cache.dockerfile
          by:
            - package.json
            - pnpm-lock.yaml
        
        # ç¬¬äºŒé˜¶æ®µï¼šä½¿ç”¨ç¼“å­˜æ„å»ºé¡¹ç›®
        - name: build-project
          image: "*build-cache"
          commands:
            - /usr/local/bin/setup-cache.sh
            - /usr/local/bin/build-astro.sh

# PRåˆ†æ”¯ï¼šå¿«é€Ÿæ„å»ºæ£€æŸ¥
merge_request:
  - docker:
      image: node:18-alpine
      commands:
        - echo "ğŸ” PRæ„å»ºæ£€æŸ¥"
        - apk add --no-cache git python3 py3-pip
        - npm install -g pnpm@latest
        - pnpm config set registry https://mirrors.cloud.tencent.com/npm/
        - pnpm install --frozen-lockfile
        - pnpm run build


