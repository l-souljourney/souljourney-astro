# è…¾è®¯äº‘ CNB (Cloud Native Builder) æ„å»ºé…ç½®æ–‡ä»¶
# L-Souljourney åšå®¢åŒçº¿éƒ¨ç½²é…ç½®

# ä¸»åˆ†æ”¯è§¦å‘é…ç½®
main:
  # Git æ¨é€äº‹ä»¶è§¦å‘
  push:
    - name: astro-blog-deploy
      # ç¯å¢ƒå˜é‡
      env:
        NODE_ENV: production
        NODE_OPTIONS: --max_old_space_size=4096
        ASTRO_TELEMETRY_DISABLED: "1"
        TZ: Asia/Shanghai
      
      # æ„å»ºé•œåƒ
      image: node:18
      
      # æ„å»ºé˜¶æ®µ
      stages:
        # ç¯å¢ƒå‡†å¤‡é˜¶æ®µ
        - name: setup-environment
          script: |
            echo "ğŸš€ å¼€å§‹æ„å»º L-Souljourney åšå®¢..."
            echo "ğŸ“¦ å®‰è£… pnpm åŒ…ç®¡ç†å™¨..."
            npm install -g pnpm@latest
            echo "âœ… ç¯å¢ƒä¿¡æ¯:"
            node --version
            npm --version
            pnpm --version
            
        # ä¾èµ–å®‰è£…é˜¶æ®µ
        - name: install-dependencies
          script: |
            echo "ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–..."
            pnpm install --frozen-lockfile
            echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
            
        # é¡¹ç›®æ„å»ºé˜¶æ®µ
        - name: build-project
          script: |
            echo "ğŸ”¨ å¼€å§‹æ„å»º Astro é¡¹ç›®..."
            pnpm build
            echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
            ls -la dist/
            du -sh dist/
            find dist -type f | wc -l | xargs echo "æ–‡ä»¶æ•°é‡:"
            echo "âœ… æ„å»ºå®Œæˆ"
            
        # éƒ¨ç½²åˆ° COS
        - name: deploy-to-cos
          image: cnbcool/tencent-cos
          settings:
            bucket: souljourney-1251969283
            region: ap-shanghai
            source: ./dist/
            target: /
            delete_extra: true
            exclude:
              - "*.map"
              - "*.log"
              - ".DS_Store"
            headers:
              "*.html":
                content-type: "text/html; charset=utf-8"
                cache-control: "public, max-age=3600"
              "*.css":
                content-type: "text/css; charset=utf-8"
                cache-control: "public, max-age=31536000"
              "*.js":
                content-type: "application/javascript; charset=utf-8"
                cache-control: "public, max-age=31536000"
              "*.{jpg,jpeg,png,gif,webp,svg,ico}":
                cache-control: "public, max-age=31536000"
              "*.{woff,woff2,ttf,eot}":
                cache-control: "public, max-age=31536000"
                
        # CDN åˆ·æ–°
        - name: refresh-cdn
          image: cnbcool/tencent-cdn
          settings:
            paths:
              - "/*"
            type: flush
            
        # åŒæ­¥åˆ° GitHub
        - name: sync-to-github
          when:
            - env:
                present: GITHUB_TOKEN
          script: |
            echo "ğŸ”„ å¼€å§‹åŒæ­¥åˆ° GitHub..."
            
            # é…ç½® Git
            git config --global user.email "cnb-deploy@l-souljourney.cn"
            git config --global user.name "CNB Auto Deploy"
            git config --global init.defaultBranch main
            
            # åŒæ­¥åˆ° GitHubï¼ˆè§¦å‘ Cloudflare Pagesï¼‰
            echo "ğŸ“¤ æ¨é€åˆ° GitHub ä»“åº“..."
            git remote add github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git 2>/dev/null || true
            git remote set-url github https://${GITHUB_TOKEN}@github.com/l-souljourney/souljourney-astro.git
            git push github main --force
            
            echo "âœ… åŒæ­¥åˆ° GitHub å®Œæˆ"
            
        # éƒ¨ç½²å®Œæˆé€šçŸ¥
        - name: deployment-notification
          script: |
            echo "ğŸ‰ åšå®¢éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸŒ å›½å†…è®¿é—®: https://blog.l-souljourney.cn"
            echo "ğŸŒ æµ·å¤–è®¿é—®: ç­‰å¾… Cloudflare Pages æ„å»ºå®Œæˆ"
            echo "ğŸ“Š æœ¬æ¬¡éƒ¨ç½²ç»Ÿè®¡:"
            echo "   - æ„å»ºæ—¶é—´: $(date)"
            echo "   - Git æäº¤: $CNB_GIT_COMMIT_SHA"
            echo "   - åˆ†æ”¯: $CNB_GIT_REF"
            
      # ç¼“å­˜é…ç½®
      cache:
        paths:
          - node_modules
          - .pnpm-store
        key: pnpm-cache-{{ checksum "pnpm-lock.yaml" }}
        
      # èµ„æºé™åˆ¶
      resources:
        cpu: 2
        memory: 4096
        timeout: 1800  # 30åˆ†é’Ÿè¶…æ—¶

# å¼€å‘åˆ†æ”¯è§¦å‘é…ç½®
develop:
  # Git æ¨é€äº‹ä»¶è§¦å‘ï¼ˆä»…æ„å»ºæµ‹è¯•ï¼Œä¸éƒ¨ç½²ï¼‰
  push:
    - name: astro-blog-test
      env:
        NODE_ENV: development
        ASTRO_TELEMETRY_DISABLED: "1"
      
      image: node:18
      
      stages:
        - name: setup-environment
          script: |
            echo "ğŸ§ª å¼€å§‹æµ‹è¯•æ„å»º..."
            npm install -g pnpm@latest
            
        - name: install-dependencies
          script: |
            echo "ğŸ“š å®‰è£…é¡¹ç›®ä¾èµ–..."
            pnpm install --frozen-lockfile
            
        - name: build-test
          script: |
            echo "ğŸ”¨ æµ‹è¯•æ„å»º Astro é¡¹ç›®..."
            pnpm build
            echo "âœ… æµ‹è¯•æ„å»ºå®Œæˆ"
            
        - name: test-complete
          script: |
            echo "ğŸ¯ æµ‹è¯•æ„å»ºæˆåŠŸï¼"
            echo "ğŸ“‹ æ„å»ºç»“æœ:"
            ls -la dist/
            du -sh dist/
            
      cache:
        paths:
          - node_modules
          - .pnpm-store
        key: pnpm-cache-test-{{ checksum "pnpm-lock.yaml" }}

# Pull Request äº‹ä»¶
"**":
  pull_request:
    - name: pr-build-check
      env:
        NODE_ENV: development
        ASTRO_TELEMETRY_DISABLED: "1"
      
      image: node:18
      
      stages:
        - name: pr-check
          script: |
            echo "ğŸ” PR æ„å»ºæ£€æŸ¥..."
            npm install -g pnpm@latest
            pnpm install --frozen-lockfile
            pnpm build
            echo "âœ… PR æ„å»ºæ£€æŸ¥é€šè¿‡"
            
      cache:
        paths:
          - node_modules
          - .pnpm-store
        key: pnpm-cache-pr-{{ checksum "pnpm-lock.yaml" }}

# å…œåº•é…ç½® - å…¶ä»–åˆ†æ”¯çš„æ¨é€äº‹ä»¶
"$":
  push:
    - name: other-branch-build
      env:
        NODE_ENV: development
        ASTRO_TELEMETRY_DISABLED: "1"
      
      image: node:18
      
      stages:
        - name: branch-build-test
          script: |
            echo "ğŸŒ¿ åˆ†æ”¯æ„å»ºæµ‹è¯•: $CNB_GIT_REF"
            npm install -g pnpm@latest
            pnpm install --frozen-lockfile
            pnpm build
            echo "âœ… åˆ†æ”¯æ„å»ºæµ‹è¯•å®Œæˆ" 