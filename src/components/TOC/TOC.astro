---
const { headings } = Astro.props;
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);


// 只获取 h3 级别的标题
const toc = headings?.filter((heading) => heading.depth === 3) || [];
---


{
  toc.length > 0 && (
    <aside class="sticky top-[calc(66px+0.68rem)] z-10 flex-shrink-0 w-[19rem] h-fit p-5 flex flex-col gap-3 rounded-2xl bg-white shadow-sm overflow-visible transition-[top] duration-300 max-xl:hidden dark:bg-[#252525]">
      <h3 class="w-full text-[0.68rem] font-normal text-primary/56 m-0">{t('aside.toc')}</h3>
      <nav class="h-auto overflow-visible">
        <ul class="list-none p-0 m-0">
          {toc.map((heading) => (
            <li class="mb-[0.4rem] leading-[1.5]">
              <a href={`#${heading.slug}`} class="block text-primary/66 no-underline transition-colors duration-300 py-1.5 text-[0.9rem] hover:text-primary [&.active]:text-primary [&.active]:font-medium">
                {heading.text}
              </a>
            </li>
          ))}
        </ul>
      </nav>
    </aside>
  )
}

<script>
  // 滚动高亮功能
  function initTocHighlight() {
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute('id');
          const tocLink = document.querySelector(`.toc a[href="#${id}"]`);
          
          if (entry.isIntersecting) {
            // 移除所有 active 类
            document.querySelectorAll('.toc a').forEach(link => {
              link.classList.remove('active');
            });
            // 添加 active 类到当前项
            if (tocLink) {
              tocLink.classList.add('active');
            }
          }
        });
      },
      {
        rootMargin: '-100px 0px -66%',
        threshold: 0
      }
    );

    // 监听所有标题元素
    document.querySelectorAll('article h2, article h3, article h4').forEach((heading) => {
      observer.observe(heading);
    });
  }

  // 页面加载时初始化
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTocHighlight);
  } else {
    initTocHighlight();
  }

  // Astro View Transitions 会自动重新执行脚本
  // 无需手动监听页面切换事件
</script>
