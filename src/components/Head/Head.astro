---
import SITE_CONFIG from "@/config";
// i18n
import { getLangFromUrl } from '@/i18n/utils';
const lang = getLangFromUrl(Astro.url);
// å½“å‰é¡µé¢çš„ URL å…ƒåœ°å€
const canonicalData = new URL(Astro.url.pathname, Astro.site);
const canonicalURL = canonicalData.href.replace(/\/+$/, "");
// ç”Ÿæˆè¯­è¨€åˆ‡æ¢é“¾æ¥ï¼ˆhreflangï¼‰
const altLangURL = lang === 'zh' 
  ? new URL(`/en${Astro.url.pathname}`, Astro.site).href.replace(/\/+$/, "")
  : new URL(Astro.url.pathname.replace(/^\/en/, ''), Astro.site).href.replace(/\/+$/, "");
// é¡µé¢å†…å®¹çš„å…ƒæ•°æ®
const { Title, Keywords, Description, PageCover } = Astro.props;
const { Site, Title: SiteName, Subtitle, Author, Cover, DNSOptimization } = SITE_CONFIG;
const WebTitle = Title || SiteName;
const SiteCover = Site + Cover;
const WebCover = PageCover || SiteCover;
// Schema.org ç»“æ„åŒ–æ•°æ®ï¼ˆJSON-LDï¼‰
const WebSiteData = { "@context": "https://schema.org", "@type": "WebSite", name: WebTitle, url: canonicalURL, image: { "@type": "ImageObject", url: SiteCover } };
const ArticleData = { "@context": "https://schema.org", "@type": "BlogPosting", headline: WebTitle, image: [WebCover], author: { "@type": "Person", name: Author, url: Site }, publisher: { "@type": "Organization", name: SiteName, logo: { "@type": "ImageObject", url: SiteCover } } };
// Base.less has been migrated to globals.css (loaded in Layout.astro)
---

<head>
	<meta charset="UTF-8" />
	
	<!-- ğŸ”¥ é˜²æ­¢æš—é»‘æ¨¡å¼ FOUCï¼šåœ¨ä»»ä½•æ¸²æŸ“å‰ç«‹å³åº”ç”¨ä¸»é¢˜ -->
	<script is:inline>
		(function() {
			const theme = localStorage?.getItem('theme') ?? 
			              (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
			if (theme === 'dark') {
				document.documentElement.classList.add('dark');
			}
		})();
	</script>

	<!-- Umami Analytics -->
	<script defer src="https://cloud.umami.is/script.js" data-website-id="162fb55d-993b-49b8-ae14-2429fd3a2a90"></script>
	
	<meta http-equiv="X-UA-Compatible" content="ie=edge" />
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
	<meta name="referrer" content="no-referrer" />
	<title>{Title ? `${Title} | ${SiteName}` : `${SiteName} - ${Subtitle}`}</title>
	<meta name="keywords" content={(Keywords || ["Astro", "åˆ†äº«", "åšå®¢"]).join(", ")} />
	<meta name="description" content={Description} />
	<meta name="format-detection" content="telephone=no, email=no, date=no, address=no" />
    <link rel="alternate" type="application/rss+xml" title={Title} href={lang === 'en' ? '/en/rss.xml' : '/rss.xml'} />
	<!-- å…ƒæ•°æ® -->
	<meta name="title" content={WebTitle} />
	<meta name="site" content={Site} />
	<meta name="author" content={Author} />
	<meta name="generator" content={Astro.generator} />
	<meta name="robots" content="index, follow, max-image-preview:large" />
	<meta itemprop="image" content={WebCover} />
	<!-- Open Graph -->
	<meta property="article:author" content={Author} />
	<meta property="og:type" content={PageCover ? "article" : "website"} />
	<meta property="og:site_name" content={SiteName} />
	<meta property="og:title" content={WebTitle} />
	<meta property="og:description" content={Description} />
	<meta property="og:url" content={canonicalURL} />
	<meta property="og:image" content={WebCover} />
	<meta property="og:locale" content={lang === 'zh' ? 'zh_CN' : 'en_US'} />
	<!-- Twitter -->
	<meta name="twitter:card" content="summary_large_image" />
	<meta name="twitter:site" content={SiteName} />
	<meta name="twitter:creator" content={Author} />
	<meta name="twitter:title" content={WebTitle} />
	<meta name="twitter:description" content={Description} />
	<meta name="twitter:url" content={canonicalURL} />
	<meta name="twitter:image" content={WebCover} />
	<!-- è¾“å‡ºç»“æ„åŒ–æ•°æ® -->
	<script type="application/ld+json" set:html={JSON.stringify(PageCover ? ArticleData : WebSiteData)} is:inline />
	<!-- Sitemap -->
	<link rel="sitemap" href="/sitemap-index.xml" />
	<!-- DNSé¢„è§£æ -->
	{DNSOptimization.map((url: string) => <link rel="dns-prefetch" href={url} />)}
	{DNSOptimization.map((url: string) => <link rel="preconnect" href={url} />)}
	<!-- LINK æ ‡ç­¾ -->
	<link rel="canonical" href={canonicalURL} />
	<!-- hreflang for SEO -->
	<link rel="alternate" hreflang="zh" href={lang === 'zh' ? canonicalURL : altLangURL} />
	<link rel="alternate" hreflang="en" href={lang === 'en' ? canonicalURL : altLangURL} />
	<link rel="alternate" hreflang="x-default" href={lang === 'zh' ? canonicalURL : altLangURL} />
	<link rel="icon" type="image/x-icon" href="/favicon.ico" />
	<slot />
</head>
