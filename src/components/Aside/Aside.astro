---
// 静态图片
// Svg 组件
import Svg from "@/components/Svg/Svg.astro";
// 时间处理
import { fmtTime } from "@/utils/index";
// 分类映射功能
import { getCategoryDisplayName } from "@/utils/categoryMapping";
// 获取用户配置数据
import SITE_CONFIG from "@/config";
const { Avatar, Author, Motto, WebSites, GoogleAds, AsideShow } = SITE_CONFIG;
// 获取文章数据
import { getCategories, getTags, getRecommendArticles, getCountInfo } from "@/utils/getPostInfo";
// I18n
import { getLangFromUrl, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// 获取数据统计
// 分类列表
const categories = getCategories(lang);
// 热门标签
const tags = getTags(lang);
// 获取网站统计数据
const CountInfo = getCountInfo(lang);
// 最新文章
const recommendArticles = getRecommendArticles(lang);
// Google 广告组件
import GoogleAd from "@/components/GoogleAd/GoogleAd.astro";
---

<aside class="flex flex-col gap-4 w-full md:w-[19rem] shrink-0">
	<!-- 头像块 -->
	{
		AsideShow.WebSitesShow && (
			<section class="relative flex flex-col items-center gap-3 w-full p-5 py-[1.88rem] bg-card text-card-foreground rounded-2xl shadow-sm border border-border">
				<img class="relative w-[6.36rem] h-[6.36rem] rounded-2xl overflow-hidden" src={Avatar} alt={t('site.author')} />
				<span class="relative text-xl font-bold after:content-[''] after:absolute after:bottom-[-0.16rem] after:left-1/2 after:-translate-x-1/2 after:w-[36%] after:h-[0.26rem] after:rounded-[3px] after:bg-primary/88">{t('site.author')}</span>
				<p class="text-[0.86rem] text-primary/66 leading-normal text-center">{t('site.subtitle')}</p>
				<section class="flex items-center gap-2">
					{WebSites.map(item => (
						<a class="flex items-center justify-center w-[1.88rem] h-[1.88rem] border border-zinc-300 dark:border-zinc-700 bg-white dark:bg-[#252525] text-zinc-600 dark:text-zinc-400 rounded-[0.38rem] transition-all duration-200 ease-out hover:text-white hover:border-primary hover:bg-primary hover:scale-110" href={item.link} title={item.text} target="_blank" rel="noopener nofollow">
							<div class="w-auto h-[1.18rem] object-contain stroke-[3px]"><Svg src={item.icon} /></div>
						</a>
					))}
				</section>
				<section class="px-4 grid grid-cols-3 w-full h-max">
					<div class="py-[0.88rem] pb-[0.66rem] flex flex-col justify-center gap-[0.28rem] text-center bg-white rounded-2xl select-none transition-shadow duration-200 ease-out hover:shadow-lg hover:z-10 dark:bg-[#252525]">
						<span class="text-[1.05rem] text-primary dark:text-[#e8e8e8]">{CountInfo.ArticleCount}</span>
						<p class="text-[0.8rem] text-primary/56">{t('aside.articles')}</p>
					</div>
					<div class="py-[0.88rem] pb-[0.66rem] flex flex-col justify-center gap-[0.28rem] text-center bg-white rounded-2xl select-none transition-shadow duration-180 hover:shadow-lg hover:z-10 dark:bg-[#252525]">
						<span class="text-[1.05rem] text-primary dark:text-[#e8e8e8]">{CountInfo.CategoryCount}</span>
						<p class="text-[0.8rem] text-primary/56">{t('aside.categories')}</p>
					</div>
					<div class="py-[0.88rem] pb-[0.66rem] flex flex-col justify-center gap-[0.28rem] text-center bg-white rounded-2xl select-none transition-shadow duration-180 hover:shadow-lg hover:z-10 dark:bg-[#252525]">
						<span class="text-[1.05rem] text-primary dark:text-[#e8e8e8]">{CountInfo.TagCount}</span>
						<p class="text-[0.8rem] text-primary/56">{t('aside.tags')}</p>
					</div>
				</section>
				<canvas class="absolute left-0 top-0 w-full h-full overflow-hidden z-10 pointer-events-none" width="888" height="1888" />
			</section>
		)
	}

	<!-- 公众号二维码块 -->
	{
		SITE_CONFIG.WeChat && (
			<section class="relative flex flex-col items-center gap-3 w-full p-5 bg-card text-card-foreground rounded-2xl shadow-sm border border-border">
				<div class="flex flex-col items-center gap-[0.8rem] w-full">
					<div class="w-[120px] h-[120px] rounded-lg overflow-hidden shadow-[0_2px_8px_rgba(0,0,0,0.1)] transition-transform duration-200 hover:scale-105">
						<img src={SITE_CONFIG.WeChat.QRCode} alt={`关注公众号 ${SITE_CONFIG.WeChat.Name}`} class="w-full h-full object-cover" />
					</div>
					<p class="text-[0.9rem] font-semibold text-primary dark:text-[#e8e8e8] text-center m-0">{SITE_CONFIG.WeChat.Name}</p>
					<p class="text-[0.75rem] text-primary/66 text-center leading-[1.4] m-0 px-2">{t('aside.wechat.desc')}</p>
				</div>
			</section>
		)
	}

	<!-- 分类块 -->
	{
		AsideShow.CategoriesShow && (
			<section class="relative flex flex-col items-center gap-3 w-full p-5 bg-card text-card-foreground rounded-2xl shadow-sm border border-border">
				<h3 class="w-full text-[0.68rem] font-normal text-primary/56">{t('aside.category.title')}</h3>
				<div class="flex flex-col w-full h-max max-h-[15.56rem] overflow-x-hidden overflow-y-auto">
					{categories
						.sort((a: any, b: any) => b.count - a.count)
						.map(i => (
							<a href={`${lang === 'en' ? '/en' : ''}/categories/${i.title}`} class="shrink-0 flex items-center justify-between w-full h-[2.18rem] text-[0.88rem] rounded-[0.38rem] bg-white transition-all duration-200 ease-out overflow-hidden hover:bg-primary/8 hover:text-primary hover:scale-[1.02] group dark:bg-[#252525] dark:hover:bg-primary/16">
								<span class="ml-2">{getCategoryDisplayName(i.title, lang)}</span>
								<i class="flex items-center justify-center w-[1.68rem] h-[1.28rem] text-white text-[0.66rem] not-italic rounded-[0.38rem] bg-primary/66 transition-all duration-200 ease-out group-hover:bg-primary group-hover:scale-110">{i.count}</i>
							</a>
						))}
				</div>
			</section>
		)
	}

	<!-- 标签块 -->
	{
		AsideShow.TagsShow && (
			<section class="relative flex flex-col items-center gap-3 w-full p-5 bg-card text-card-foreground rounded-2xl shadow-sm border border-border">
				<h3 class="w-full text-[0.68rem] font-normal text-primary/56">{t('aside.tag.title')}</h3>
				<div class="flex flex-wrap gap-[0.68rem_1rem] w-full h-max max-h-[18.88rem] overflow-x-hidden overflow-y-auto">
					{tags.map(i => (
						<a href={`${lang === 'en' ? '/en' : ''}/tag/${i[0]}`} class="flex items-center gap-[0.18rem] w-max h-max group">
							<span class="w-max text-[0.8rem] leading-normal transition-colors duration-200 ease-out overflow-hidden group-hover:text-primary">{i[0]}</span>
							<em class="text-primary/28 text-[0.688rem] not-italic">{i[1]}</em>
						</a>
					))}
				</div>
			</section>
		)
	}

	<section class="sticky top-[calc(66px+1rem)] flex flex-col gap-4 w-full">
		<!-- 最新文章块 -->
		{
			recommendArticles.length && AsideShow.recommendArticleShow && (
				<section class="relative flex flex-col items-center gap-3 w-full p-5 bg-card text-card-foreground rounded-2xl shadow-sm border border-border">
					<h3 class="w-full text-[0.68rem] font-normal text-primary/56">{t('aside.recommend')}</h3>
					<div class="flex flex-col gap-2 w-full h-max overflow-hidden">
						{recommendArticles.map((i, idx) => (
						<a href={`${lang === 'en' ? '/en' : ''}/article/${i.id.replace('en/', '')}`} class="flex flex-col gap-1 w-full py-2 overflow-hidden group transition-transform duration-200 ease-out hover:translate-x-0.5">
							<span class="flex items-center gap-2.5 w-full">
								{idx < 3 ? (
									<i class={`shrink-0 w-5 h-5 flex items-center justify-center rounded text-white text-center text-[0.75rem] font-medium not-italic ${idx === 0 ? 'bg-success' : idx === 1 ? 'bg-warning' : 'bg-import'}`}>{idx + 1}</i>
								) : (
									<em class="shrink-0 w-5 text-center not-italic text-sm font-medium text-primary/56">{idx + 1}.</em>
								)}
								<cite class="flex-1 min-w-0 text-[0.875rem] leading-normal not-italic transition-colors duration-200 ease-out relative after:content-[''] after:block after:absolute after:bottom-0 after:left-0 after:w-full after:h-px after:bg-primary after:origin-left after:scale-x-0 after:transition-transform after:duration-200 after:ease-out group-hover:text-primary group-hover:after:scale-x-100 line-clamp-1">{i.title}</cite>
							</span>
							<time class="text-primary/56 text-[0.688rem] ml-7">{fmtTime(i.date, "YYYY-MM-DD A")}</time>
						</a>
					))}
					</div>
				</section>
			)
		}

		<!-- 谷歌广告块 -->
		{
			GoogleAds.ad_Client && GoogleAds.asideAD_Slot && (
				<section class="relative flex flex-col items-center gap-3 w-full p-5 bg-card text-card-foreground rounded-2xl shadow-sm border border-border">
					<h3 class="w-full text-[0.68rem] font-normal text-primary/56">{t('aside.ad')}</h3>
					<GoogleAd className={`mb-4 p-3 rounded-lg bg-white shadow-sm overflow-hidden relative before:absolute before:left-1/2 before:top-[30%] before:-translate-x-1/2 before:-translate-y-1/2 before:content-['${t('aside.ad.loading')}'] before:text-[#e3e4e6] before:-z-10 dark:bg-[#252525]`} slotID={GoogleAds.asideAD_Slot} />
				</section>
			)
		}
	</section>
</aside>
