---
import Search from "astro-pagefind/components/Search";
import "./Search.less";
---

<section class="vh-search">
	<main>
        <div class="pagefind-wrapper">
		    <Search id="search" className="pagefind-ui" uiOptions={{ showImages: false }} />
        </div>
	</main>
</section>

<script>
    // Simple toggle logic for the search modal
    const initSearchModal = () => {
        const searchBtn = document.querySelector(".search-btn");
        const searchModal = document.querySelector(".vh-search");
        const searchMain = document.querySelector(".vh-search > main");

        if (!searchBtn || !searchModal || !searchMain) return;

        const openModal = () => {
            searchModal.classList.add("active");
            // Focus the input if possible, though pagefind might render it async
            setTimeout(() => {
                const input = searchModal.querySelector("input");
                if (input) input.focus();
            }, 100);
        };

        const closeModal = () => {
            searchModal.classList.remove("active");
        };

        searchBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            openModal();
        });

        searchModal.addEventListener("click", (e) => {
            closeModal();
        });

        searchMain.addEventListener("click", (e) => {
            e.stopPropagation();
        });
        
        // Close on escape key
        document.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && searchModal.classList.contains("active")) {
                closeModal();
            }
        });
    };

    // Run on initial load
    initSearchModal();

    // Run on view transitions navigation
    document.addEventListener("astro:page-load", initSearchModal);
</script>

<style is:global>
    /* Override Pagefind styles to match the modal */
    .vh-search .pagefind-wrapper {
        width: 100%;
    }
    
    .vh-search .pagefind-ui {
        width: 100%;
    }

    .vh-search .pagefind-ui .pagefind-ui__search-input {
        background-color: var(--vh-font-6);
        border: none;
        border-radius: 0.66rem;
        padding: 1rem 1rem 1rem 2.5rem; /* Add left padding for the icon */
        font-size: 1rem;
        color: var(--vh-font-color);
        box-sizing: border-box;
    }
    
    /* Position the search icon */
    .vh-search .pagefind-ui .pagefind-ui__search-clear {
        background-color: transparent;
        top: 50%;
        transform: translateY(-50%);
    }
    
    /* Ensure the form relative positioning for icon */
    .vh-search .pagefind-ui form {
        position: relative;
    }
    
    /* Custom icon styling if needed, or rely on Pagefind's default */
    .vh-search .pagefind-ui .pagefind-ui__search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        opacity: 0.6;
    }

    .vh-search .pagefind-ui .pagefind-ui__drawer {
        background-color: var(--vh-white-color);
        max-height: 70vh;
        overflow-y: auto;
    }

    .vh-search .pagefind-ui .pagefind-ui__result {
        border-bottom: 1px solid var(--vh-font-6);
        padding: 1rem 0;
    }

    .vh-search .pagefind-ui .pagefind-ui__result-title {
        font-size: 1.1rem;
        font-weight: 600;
    }
    
    
    /* ========== Dark Mode Overrides ========== */
    html.dark .vh-search {
        /* Color variables for dark mode */
        --search-dark-bg-input: rgba(255, 255, 255, 0.08);
        --search-dark-bg-hover: rgba(255, 255, 255, 0.12);
        --search-dark-border: rgba(255, 255, 255, 0.15);
        --search-dark-text-primary: #eeeeee;
        --search-dark-text-secondary: #aaaaaa;
        --search-dark-text-tertiary: #888888;
    }
    
    /* Input field */
    html.dark .vh-search .pagefind-ui__search-input {
        background-color: var(--search-dark-bg-input);
        color: var(--search-dark-text-primary);
    }
    
    html.dark .vh-search .pagefind-ui__search-input::placeholder {
        color: var(--search-dark-text-secondary);
        opacity: 0.6;
    }
    
    /* Results container */
    html.dark .vh-search .pagefind-ui__drawer {
        background-color: transparent;
    }
    
    /* Individual result items */
    html.dark .vh-search .pagefind-ui__result {
        border-bottom-color: var(--search-dark-border);
    }
    
    html.dark .vh-search .pagefind-ui__result-title a {
        color: var(--search-dark-text-primary);
    }
    
    html.dark .vh-search .pagefind-ui__result-excerpt {
        color: var(--search-dark-text-secondary);
    }
    
    html.dark .vh-search .pagefind-ui__result-link {
        color: var(--search-dark-text-tertiary);
    }
    
    html.dark .vh-search .pagefind-ui__message {
        color: var(--search-dark-text-secondary);
    }
    
    /* Buttons */
    html.dark .vh-search .pagefind-ui__button {
        background-color: var(--search-dark-bg-input);
        color: var(--search-dark-text-primary);
        border: 1px solid var(--search-dark-border);
        transition: background-color 0.18s ease-in-out;
    }
    
    html.dark .vh-search .pagefind-ui__button:hover {
        background-color: var(--search-dark-bg-hover);
    }
    
    /* Icons */
    html.dark .vh-search .pagefind-ui__search-icon svg {
        fill: var(--search-dark-text-secondary);
    }
    
    html.dark .vh-search .pagefind-ui__search-clear {
        color: var(--search-dark-text-secondary);
    }
</style>
