---
import { getDescription, fmtTime } from "@/utils/index";
import { formatDate } from "@/utils/formatDate";
// 分类映射功能
import { getCategoryDisplayName } from "@/utils/categoryMapping";
import { Icon } from 'astro-icon/components';
import { type CollectionEntry, getCollection } from "astro:content";
import { render } from "astro:content";
import getReadingTime from 'reading-time';

// i18n
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export async function getStaticPaths() {
	const posts = await getCollection("blog");
    // 仅筛选英文文章 (ID 以 en/ 开头的)
    const enPosts = posts.filter((post: any) => post.id.startsWith('en/'));
	return enPosts.map((post: any) => ({ params: { article: post.data.id }, props: post }));
}
// 处理文章内容
type Props = CollectionEntry<"blog">;
const post: any = Astro.props;
// 获取封面图
import getCover from "@/utils/getCover";
const ARTICLE_COVER: string = await getCover(post.data.cover);
// 页面 Info
import SITE_CONFIG from "@/config";
const { Site, Title, Author, GoogleAds } = SITE_CONFIG;
// 处理文章内容
const description = getDescription(post);
const { Content, remarkPluginFrontmatter, headings } = await render(post);
// 文章字数和阅读时间 - 直接从 post.body 计算
const readingTime = getReadingTime(post.body);
const article_word_count = readingTime.words;
const reading_time = readingTime.minutes;
// 公共 Layout
import Layout from "@/layouts/Layout/Layout.astro";
// Copyright 组件
import Copyright from "@/components/Copyright/Copyright.astro";
// Reward 组件
import Reward from "@/components/Reward/Reward.astro";
// Google 广告组件
import GoogleAd from "@/components/GoogleAd/GoogleAd.astro";

---

<Layout title={post.data.title} description={post.data.description}>
  <article class="flex flex-col gap-10">
    <header class="flex flex-col gap-6">
      <h1 class="text-4xl max-md:text-2xl font-bold text-primary dark:text-[#e8e8e8] leading-tight">
        {post.data.title}
      </h1>
      <div class="flex flex-wrap items-center gap-4 text-sm text-zinc-500 dark:text-zinc-400">
        <span class="flex items-center gap-1">
          <i class="iconfont icon-calendar text-lg"></i>
          {t('post.published')} {formatDate(post.data.date, 'en', 'short')}
        </span>
        <span class="flex items-center gap-1">
          <i class="iconfont icon-folder text-lg"></i>
          {t('post.category')} 
          <a href={`/en/categories/${post.data.categories}`} class="hover:text-primary transition-colors">
            {getCategoryDisplayName(post.data.categories, 'en')}
          </a>
        </span>
				<span class="inline-flex items-center gap-1.5">
					<Icon name="file-text" class="w-4 h-4 text-primary/80" />
					{t('post.words')} {article_word_count} {t('post.words')}
				</span>
				<span class="inline-flex items-center gap-1.5">
					<Icon name="clock" class="w-4 h-4 text-primary/80" />
					{t('post.readTime')} ≈ {Math.ceil(reading_time)} {t('post.readTime')}
				</span>
			</section>
		</header>
		<article
			class="
			prose lg:prose-xl
			prose-zinc
			dark:prose-invert
			max-w-none
			px-8 pb-8
		"
		>	<Content />
			<section class="flex flex-wrap gap-2 mt-6 not-prose">
				{
					(post.data.tags || []).map((i: any) => (
						<a 
							href={`/tag/${i}`}
							class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium text-muted-foreground border border-border rounded-md hover:bg-accent hover:text-accent-foreground transition-colors duration-180"
						>
							<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
								<path stroke="none" d="M0 0h24v24H0z" fill="none" />
								<path d="M7.5 7.5m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0" />
								<path d="M3 6v5.172a2 2 0 0 0 .586 1.414l7.71 7.71a2.41 2.41 0 0 0 3.408 0l5.592 -5.592a2.41 2.41 0 0 0 0 -3.408l-7.71 -7.71a2 2 0 0 0 -1.414 -.586h-5.172a3 3 0 0 0 -3 3z" />
							</svg>
							{i}
						</a>
					))
				}
			</section>
		</main>
		<footer>
			<!-- 公众号引流组件 -->
			<Reward />
			<!-- 版权©️信息 -->
			<Copyright site={Site} id={post.data.id} title={post.data.title} sitename={Title} time={fmtTime(post.data.date, "YYYY-MM-DD A")} auther={Author} />
			<!-- 底部谷歌广告 -->
			{GoogleAds.ad_Client && GoogleAds.articleAD_Slot && <GoogleAd className="vh-article-ad" slotID={GoogleAds.articleAD_Slot} />}
		</footer>
	</article>
</Layout>
