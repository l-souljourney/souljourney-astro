---
import { getCollection } from "astro:content";
import { getLangFromUrl, useTranslations } from '@/i18n/utils';
import { getCategoryDisplayName } from "@/utils/categoryMapping";
// 公共 Layout
import Layout from "@/layouts/Layout/Layout.astro";
// 文章列表组件
import Archive from "@/components/Archive/Archive.astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  // Filter for English posts
  const enPosts = posts.filter((post: any) => post.id.startsWith('en/'));
  
  // Get unique categories from English posts
  const categories = [...new Set(enPosts.map((post: any) => post.data.categories))];
  
  return categories.map((category) => ({
    params: { categories: category },
  }));
}

const { categories } = Astro.params;
const lang = getLangFromUrl(Astro.url);
const categoryDisplayName = getCategoryDisplayName(categories, 'en');

const posts = await getCollection("blog");
// Filter for English posts
const enPosts = posts.filter((post: any) => post.id.startsWith('en/'));
const filteredPosts = enPosts
  .filter((post: any) => post.data.categories === categories)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// 按年份分组
const articlesByYear = new Map<number, any[]>();
filteredPosts.forEach(post => {
  const year = post.data.date.getFullYear();
  if (!articlesByYear.has(year)) {
    articlesByYear.set(year, []);
  }
  articlesByYear.get(year)!.push(post);
});

// 转换为 Archive 组件需要的格式
const articleList = Array.from(articlesByYear.entries())
  .sort((a, b) => b[0] - a[0]) // 按年份降序
  .map(([year, posts]) => ({
    name: year,
    data: posts.map(post => post.data)
  }));
  
// 页面 Info
const info = {
  title: `Category: ${categoryDisplayName} | L-忠程丨生死看淡不服就淦`,
  description: "L-忠程的博客,分享技术、投资、生活与感悟",
};
---

<Layout title={info.title} description={info.description} activeNav={categories}>
	<Archive articleList={articleList} />
</Layout>
