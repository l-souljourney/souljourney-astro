---
import { getCategoriesList } from "@/utils/getArchive";
import { getCollection } from "astro:content";
import { getCategoryDisplayName, getAllCategoryPaths } from "@/utils/categoryMapping";
import { getLangFromUrl, useTranslations } from '@/i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

export async function getStaticPaths(): Promise<any> {
	const posts = await getCollection("blog");
	// 过滤英文文章
	const enPosts = posts.filter((post: any) => post.id.startsWith('en/'));
	// 获取所有文章使用的分类
	const usedCategories = new Set(enPosts.map((post: any) => post.data.categories));
	// 获取所有配置的分类
	const allCategories = getAllCategoryPaths();
	// 合并：文章分类 + 配置的分类（确保所有导航中的分类都有页面）
	const allPaths = new Set([...usedCategories, ...allCategories]);
	// 生成所有分类的页面路径
	return Array.from(allPaths).map((category: string) => ({ 
		params: { categories: category }, 
		props: { category } 
	}));
}
// 获取分类列表
const { categories } = Astro.params;
// 特殊处理：仅获取英文文章
const allPosts = await getCollection("blog");
const enPosts = allPosts.filter((post: any) => post.id.startsWith('en/'));
const filteredPosts = enPosts
  .filter((post: any) => post.data.categories === categories)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

// 按年份分组
const articlesByYear = new Map<number, any[]>();
filteredPosts.forEach(post => {
  const year = post.data.date.getFullYear();
  if (!articlesByYear.has(year)) {
    articlesByYear.set(year, []);
  }
  articlesByYear.get(year)!.push(post);
});

// 转换为 Archive 组件需要的格式
const articleList = Array.from(articlesByYear.entries())
  .sort((a, b) => b[0] - a[0]) // 按年份降序
  .map(([year, posts]) => ({
    name: year,
    data: posts.map(post => post.data)
  }));
  
// 页面 Info
import SITE_CONFIG from "@/config";
const { Description } = SITE_CONFIG;
// 公共 Layout
import Layout from "@/layouts/Layout/Layout.astro";
// 文章列表组件
import Archive from "@/components/Archive/Archive.astro";
// 获取分类中文显示名称
const categoryDisplayName = getCategoryDisplayName(categories);
---

<Layout title={`Category: ${categoryDisplayName}`} description={Description} activeNav={categories}>
	<Archive articleList={articleList} />
</Layout>
