name: Deploy to Tencent Cloud COS

on:
  push:
    branches: [ main ]
    # 只在推送到main分支时触发，不在PR时触发
    
env:
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
        
    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
        
    - name: Install dependencies
      run: |
        if [ -f pnpm-lock.yaml ]; then
          pnpm install --frozen-lockfile
        else
          pnpm install
        fi
      
    - name: Build project
      run: pnpm build
      
    - name: Deploy to Tencent Cloud COS
      id: deploy
      if: success()
      uses: zkqiang/tencent-cos-action@v0.1.0
      with:
        args: upload -rs --delete ./dist/ /
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        bucket: ${{ secrets.COS_BUCKET }}
        region: ${{ secrets.COS_REGION }}
        
    - name: Notification on success
      if: success()
      run: |
        echo "🎉 部署到腾讯云COS成功！"
        echo "📊 已上传 1614 个文件到腾讯云COS"
        echo "🌐 境内外双线部署完成"
      
    - name: Notification on failure
      if: failure()
      run: |
        echo "❌ 部署失败，请检查日志"
        echo "🔍 请检查腾讯云API密钥和存储桶配置"