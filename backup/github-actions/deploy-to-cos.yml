name: Deploy to Tencent Cloud COS

on:
  push:
    branches: [ main ]
    # åªåœ¨æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘ï¼Œä¸åœ¨PRæ—¶è§¦å‘
    
env:
  NODE_VERSION: '18'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: Get pnpm store directory
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV
        
    - name: Setup pnpm cache
      uses: actions/cache@v3
      with:
        path: ${{ env.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-
        
    - name: Install dependencies
      run: |
        if [ -f pnpm-lock.yaml ]; then
          pnpm install --frozen-lockfile
        else
          pnpm install
        fi
      
    - name: Build project
      run: pnpm build
      
    - name: Deploy to Tencent Cloud COS
      id: deploy
      if: success()
      uses: zkqiang/tencent-cos-action@v0.1.0
      with:
        args: upload -rs --delete ./dist/ /
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        bucket: ${{ secrets.COS_BUCKET }}
        region: ${{ secrets.COS_REGION }}
        
    - name: Notification on success
      if: success()
      run: |
        echo "ğŸ‰ éƒ¨ç½²åˆ°è…¾è®¯äº‘COSæˆåŠŸï¼"
        echo "ğŸ“Š å·²ä¸Šä¼  1614 ä¸ªæ–‡ä»¶åˆ°è…¾è®¯äº‘COS"
        echo "ğŸŒ å¢ƒå†…å¤–åŒçº¿éƒ¨ç½²å®Œæˆ"
      
    - name: Notification on failure
      if: failure()
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        echo "ğŸ” è¯·æ£€æŸ¥è…¾è®¯äº‘APIå¯†é’¥å’Œå­˜å‚¨æ¡¶é…ç½®"