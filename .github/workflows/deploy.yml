name: ğŸš€ Deploy Astro Blog

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # æ„å»ºå’Œéƒ¨ç½²åˆ°è…¾è®¯äº‘COS
  deploy-to-cos:
    name: ğŸ—ï¸ Build & Deploy to Tencent COS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: ğŸ“š Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ”¨ Build Astro project
      run: pnpm build
      env:
        NODE_ENV: production
        ASTRO_TELEMETRY_DISABLED: 1
        
    - name: ğŸ“Š Verify build output
      run: |
        echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
        ls -la dist/
        du -sh dist/
        find dist -type f | wc -l | xargs echo "æ–‡ä»¶æ•°é‡:"
        echo "ğŸ” æ£€æŸ¥å¯èƒ½æœ‰é—®é¢˜çš„æ–‡ä»¶:"
        find dist -name "*.html" | grep -E "(ä¸­æ–‡|ç‰¹æ®Šå­—ç¬¦)" || echo "æœªå‘ç°æ˜æ˜¾é—®é¢˜æ–‡ä»¶"
        echo "ğŸ“ éªŒè¯å…³é”®æ–‡ä»¶å­˜åœ¨:"
        ls -la dist/index.html || echo "âš ï¸ ç¼ºå°‘index.html"
        
    - name: ğŸš€ Deploy to Tencent COS
      uses: TencentCloud/cos-action@v1
      with:
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        cos_bucket: ${{ secrets.COS_BUCKET }}
        cos_region: ${{ secrets.COS_REGION }}
        local_path: ./dist
        remote_path: /
        clean: true
        skip_src: false
        
    - name: ğŸ”„ Refresh CDN (Optional)
      if: success()
      continue-on-error: true
      run: |
        echo "ğŸ”„ éƒ¨ç½²å®Œæˆï¼ŒCDNå°†è‡ªåŠ¨åˆ·æ–°"
        echo "ğŸ’¡ å¦‚éœ€æ‰‹åŠ¨åˆ·æ–°CDNï¼Œè¯·ç™»å½•è…¾è®¯äº‘æ§åˆ¶å°"
          
    - name: ğŸ‰ Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ åšå®¢éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ å›½å†…è®¿é—®: https://blog.l-souljourney.cn"
        echo "ğŸŒ æµ·å¤–è®¿é—®: Cloudflare Pages å·²è‡ªåŠ¨æ„å»º"
        echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
        echo "   - æ„å»ºæ—¶é—´: $(date)"
        echo "   - Git æäº¤: ${{ github.sha }}"
        echo "   - åˆ†æ”¯: ${{ github.ref_name }}"
        
    - name: ğŸš¨ Debug on failure
      if: failure()
      run: |
        echo "ğŸš¨ éƒ¨ç½²å¤±è´¥ï¼Œæ”¶é›†è°ƒè¯•ä¿¡æ¯:"
        echo "ğŸ“ distç›®å½•å†…å®¹:"
        find dist -type f | head -20
        echo "ğŸ” æ£€æŸ¥æ–‡ä»¶æƒé™:"
        ls -la dist/ | head -10
        echo "ğŸ’¾ ç£ç›˜ç©ºé—´:"
        df -h

  # PRæ„å»ºæ£€æŸ¥
  pr-check:
    name: ğŸ” PR Build Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: ğŸ“š Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ”¨ Build test
      run: pnpm build
      env:
        NODE_ENV: production
        ASTRO_TELEMETRY_DISABLED: 1
        
    - name: âœ… PR Check Complete
      run: |
        echo "âœ… PR æ„å»ºæ£€æŸ¥é€šè¿‡"
        echo "ğŸ“Š æ„å»ºäº§ç‰©:"
        ls -la dist/
        echo "ğŸ¯ å¯ä»¥å®‰å…¨åˆå¹¶åˆ°ä¸»åˆ†æ”¯" 