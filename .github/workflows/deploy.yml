name: ğŸš€ Deploy Astro Blog

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # æ„å»ºå’Œéƒ¨ç½²åˆ°è…¾è®¯äº‘COS
  deploy-to-cos:
    name: ğŸ—ï¸ Build & Deploy to Tencent COS
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: ğŸ“š Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ”¨ Build Astro project
      run: pnpm build
      env:
        NODE_ENV: production
        ASTRO_TELEMETRY_DISABLED: 1
        
    - name: ğŸ“Š Show build info
      run: |
        echo "ğŸ“Š æ„å»ºäº§ç‰©ä¿¡æ¯:"
        ls -la dist/
        du -sh dist/
        find dist -type f | wc -l | xargs echo "æ–‡ä»¶æ•°é‡:"
        
    - name: ğŸš€ Deploy to Tencent COS
      uses: zkqiang/tencent-cos-action@v0.1.0
      with:
        args: upload -rs --delete ./dist/ /
        secret_id: ${{ secrets.COS_SECRET_ID }}
        secret_key: ${{ secrets.COS_SECRET_KEY }}
        bucket: ${{ vars.COS_BUCKET || 'souljourney-1251969283' }}
        region: ${{ vars.COS_REGION || 'ap-shanghai' }}
        
    - name: ğŸ”„ Refresh CDN
      if: success()
      run: |
        echo "ğŸ”„ è§¦å‘CDNåˆ·æ–°..."
        curl -X POST "https://cdn.tencentcloudapi.com/" \
          -H "Content-Type: application/json" \
          -d '{
            "Action": "PurgePathCache",
            "Version": "2018-06-06",
            "Region": "'${{ vars.COS_REGION || 'ap-shanghai' }}'",
            "Paths": ["https://blog.l-souljourney.cn/*"],
            "FlushType": "flush"
          }' || echo "âš ï¸ CDNåˆ·æ–°å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨åˆ·æ–°"
          
    - name: ğŸ‰ Deployment Success
      if: success()
      run: |
        echo "ğŸ‰ åšå®¢éƒ¨ç½²æˆåŠŸï¼"
        echo "ğŸŒ å›½å†…è®¿é—®: https://blog.l-souljourney.cn"
        echo "ğŸŒ æµ·å¤–è®¿é—®: ç­‰å¾… Cloudflare Pages æ„å»ºå®Œæˆ"
        echo "ğŸ“Š éƒ¨ç½²ç»Ÿè®¡:"
        echo "   - æ„å»ºæ—¶é—´: $(date)"
        echo "   - Git æäº¤: ${{ github.sha }}"
        echo "   - åˆ†æ”¯: ${{ github.ref_name }}"

  # PRæ„å»ºæ£€æŸ¥
  pr-check:
    name: ğŸ” PR Build Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: ğŸ“¦ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest
        
    - name: ğŸ“š Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: ğŸ”¨ Build test
      run: pnpm build
      env:
        NODE_ENV: production
        ASTRO_TELEMETRY_DISABLED: 1
        
    - name: âœ… PR Check Complete
      run: |
        echo "âœ… PR æ„å»ºæ£€æŸ¥é€šè¿‡"
        echo "ğŸ“Š æ„å»ºäº§ç‰©:"
        ls -la dist/
        echo "ğŸ¯ å¯ä»¥å®‰å…¨åˆå¹¶åˆ°ä¸»åˆ†æ”¯" 