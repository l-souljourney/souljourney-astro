name: Dispatch to Sync Hub

on:
  issues:
    types: [opened, edited, deleted, closed, reopened, labeled, unlabeled, assigned, unassigned, milestoned, demilestoned]
  pull_request:
    types: [closed]

jobs:
  dispatch:
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch Sync Event
        env:
          SYNC_TOKEN: ${{ secrets.GH_SYNC_TOKEN }}
          EVENT_CONTEXT: ${{ toJson(github.event) }}
          REPO_NAME: ${{ github.repository }}
        run: |
          # Use jq to safely construct the JSON payload to avoid shell injection and quoting issues
          PAYLOAD=$(jq -n \
            --arg repo "$REPO_NAME" \
            --argjson event "$EVENT_CONTEXT" \
            '{event_type: "github_sync", client_payload: {repo: $repo, event: $event}}')

          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $SYNC_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/l-souljourney/souljourney-code/dispatches \
            -d "$PAYLOAD"
